{% extends 'base.html.twig' %}
{% block title %}{{ post.titre }}{% endblock %}

{% block body %}
<section class="section" style="padding-top:120px;">
  <div class="container">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <a href="{{ path('post_index') }}" class="btn btn-outline-secondary">← Retour</a>
      <a href="{{ path('post_edit', {id: post.id}) }}" class="btn btn-outline-primary">Edit</a>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-body p-4 p-lg-5">

        <div class="d-flex gap-2 mb-3">
          <span class="badge bg-primary">{{ post.categorie }}</span>
          {% if post.visibilite != 'PUBLIC' %}
            <span class="badge bg-secondary">{{ post.visibilite }}</span>
          {% endif %}
        </div>

        <h2 class="mb-2">{{ post.titre }}</h2>

        <div class="text-muted mb-4">
          {{ post.dateCreation ? post.dateCreation|date('d/m/Y H:i') : '' }}
          {% if post.localisation %} · {{ post.localisation }}{% endif %}
          {% if post.user %} · <strong>{{ post.user.prenom }} {{ post.user.nom }}</strong>{% endif %}
        </div>

        {% if post.imgPost %}
          <img src="{{ asset(post.imgPost) }}" class="img-fluid rounded mb-4" alt="image post">
        {% endif %}

        <div class="fs-6">
          {{ post.contenu|nl2br }}
        </div>

        {% if post.hashtags %}
          <hr class="my-4">
          <div class="d-flex flex-wrap gap-2">
            {% for t in post.hashtags|split(' ') %}
              {% if t %}
                <span class="badge bg-light text-dark border">{{ t }}</span>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

      </div>
    </div>

  </div>
</section>

<style>
  .ig-card { border-radius: 18px; overflow: hidden; }
  .ig-divider { border-top: 1px solid rgba(0,0,0,.06); }
  .ig-avatar {
    width: 42px; height: 42px; border-radius: 50%;
    display: inline-flex; align-items: center; justify-content: center;
    background: linear-gradient(135deg, rgba(13,110,253,.15), rgba(32,201,151,.15));
    border: 1px solid rgba(0,0,0,.06);
    font-weight: 700;
  }
  .ig-name { font-weight: 700; font-size: .95rem; }
  .ig-time { font-size: .78rem; color: #6c757d; }
  .ig-bubble {
    background: #f8f9fa;
    border: 1px solid rgba(0,0,0,.06);
    border-radius: 14px;
    padding: .6rem .75rem;
    white-space: pre-wrap;
  }
  .ig-badge { font-size: .72rem; border-radius: 999px; }
  .ig-input {
    border-radius: 999px !important;
    padding-left: 1rem !important;
  }
</style>

<div class="card shadow-sm border-0 ig-card mt-4">
  <div class="card-body p-0">

    {# Header commentaires #}
    <div class="d-flex justify-content-between align-items-center px-4 py-3">
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-chat-dots"></i>
        <span class="fw-bold">Commentaires</span>
        <span class="text-muted">({{ post.commentaires|length }})</span>
      </div>

      <a class="btn btn-sm btn-outline-primary"
         href="{{ path('commentaire_add', {id: post.id}) }}">
        <i class="bi bi-plus-circle"></i> Ajouter
      </a>
    </div>

    <div class="ig-divider"></div>

    {# Liste commentaires #}
    <div class="px-4 py-3">
      {% set sorted = post.commentaires|sort((a,b) => b.dateCreation <=> a.dateCreation) %}

      {% for c in sorted %}
        <div class="d-flex gap-3 py-3 {% if not loop.last %}ig-divider{% endif %}">
          {# Avatar simple #}
          <div class="ig-avatar">
            {% if c.estAnonyme %}
              <i class="bi bi-incognito"></i>
            {% else %}
              {{ (c.user.prenom is defined and c.user.prenom) ? (c.user.prenom|slice(0,1)|upper) : (c.user.emailUser|slice(0,1)|upper) }}
            {% endif %}
          </div>

          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="ig-name">
                  {% if c.estAnonyme %}
                    Anonyme
                  {% else %}
                    {{ (c.user.prenom is defined and c.user.prenom) ? (c.user.prenom ~ ' ' ~ (c.user.nom is defined ? c.user.nom : '')) : c.user.emailUser }}
                  {% endif %}
                </div>
                <div class="ig-time">
                  {{ c.dateCreation|date('d/m/Y H:i') }}
                </div>
              </div>

              <div class="d-flex align-items-center gap-2">
                {# Badge confidentialité #}
                {% set badge =
                  c.parametresConfidentialite == 'PRIVE' ? 'danger' :
                  (c.parametresConfidentialite == 'AMIS' ? 'info' : 'success')
                %}
                <span class="badge bg-{{ badge }} ig-badge">
                  {{ c.parametresConfidentialite }}
                </span>

                {# Edit #}
                <a class="btn btn-sm btn-light"
                   href="{{ path('commentaire_edit', {id: c.id}) }}"
                   title="Modifier">
                  <i class="bi bi-pencil"></i>
                </a>

                {# Delete #}
                <form method="post"
                      action="{{ path('commentaire_delete', {id: c.id}) }}"
                      onsubmit="return confirm('Supprimer ce commentaire ?');">
                  <input type="hidden" name="token" value="{{ csrf_token('del_commentaire' ~ c.id) }}">
                  <button class="btn btn-sm btn-light" title="Supprimer">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </div>

            <div class="mt-2 ig-bubble">
              {{ c.contenu }}
            </div>

            {# footer mini comme insta #}
            <div class="d-flex gap-3 mt-2 text-muted" style="font-size:.85rem;">
              <span><i class="bi bi-heart"></i> J’aime</span>
              <span><i class="bi bi-reply"></i> Répondre</span>
            </div>
          </div>
        </div>

      {% else %}
        <div class="text-muted py-3">
          Aucun commentaire pour le moment.
        </div>
      {% endfor %}
    </div>

    {# zone “Add comment” style insta (bouton qui redirige) #}
    <div class="ig-divider"></div>
    <div class="px-4 py-3 d-flex gap-2 align-items-center">
      <div class="ig-avatar" style="width:38px;height:38px;">U</div>
      <input class="form-control ig-input"
             placeholder="Ajouter un commentaire..."
             readonly
             onclick="window.location='{{ path('commentaire_add', {id: post.id}) }}'">
      <a class="btn btn-primary rounded-pill"
         href="{{ path('commentaire_add', {id: post.id}) }}">
        Publier
      </a>
    </div>

  </div>
</div>

{% endblock %}
