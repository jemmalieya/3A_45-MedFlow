{% extends 'base_dashboard.html.twig' %}
{% block body %}
<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        letter-spacing: -0.5px;
    }
    .page-header p {
        font-size: 1.1rem;
        opacity: 0.95;
        margin: 0;
    }
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    .card:hover {
        box-shadow: 0 10px 35px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 20px 24px;
    }
    .card-header h6 {
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: 0.3px;
    }
    .card-body {
        padding: 25px;
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        color: white;
    }
    .btn-secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        border: none;
        color: white;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    .btn-secondary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(107, 114, 128, 0.3);
    }
    .alert {
        border: none;
        border-radius: 10px;
        border-left: 4px solid;
        margin-bottom: 20px;
        animation: slideIn 0.4s ease;
    }
    .alert-danger {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-left-color: #dc2626;
        color: #7f1d1d;
    }
    .alert-success {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border-left-color: #16a34a;
        color: #15803d;
    }
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .form-control {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .form-group label {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
    }
    .text-danger { color: #dc2626 !important; }
</style>

<div class="container-fluid">

                    <!-- Page Heading -->
                    <div class="page-header">
                        <h1>ü©∫ Consultation En Ligne</h1>
                        <p>Fiche m√©dicale ‚Äì consultation en ligne</p>
                    </div>

                    {# Parse server-side errors for each field #}
                    {# Use flashed fieldErrors if present, else default #}
                    {% set flashedFieldErrors = app.flashes('fieldErrors') %}
                    {% if flashedFieldErrors and flashedFieldErrors[0] is defined %}
                        {% set fieldErrors = flashedFieldErrors[0] %}
                        {% if fieldErrors.prescriptions is not defined %}
                            {% set fieldErrors = fieldErrors|merge({'prescriptions': []}) %}
                        {% endif %}
                    {% else %}
                        {% set fieldErrors = {'diagnostic': [], 'observations': [], 'resultatsExamens': [], 'prescriptions': []} %}
                    {% endif %}
                    {% set globalErrors = globalErrors|default([]) %}
                    {% for message in app.flashes('error') %}
                        {% set globalErrors = globalErrors|merge([message]) %}
                    {% endfor %}
                    {% if globalErrors %}
                        <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
                            <strong>‚ùå Validation Error:</strong>
                            {% for message in globalErrors %}
                                <div>{{ message }}</div>
                            {% endfor %}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endif %}
                    {% if app.flashes('success') %}
                        <div class="alert alert-success alert-dismissible fade show m-3" role="alert">
                            <strong>‚úÖ Success:</strong>
                            {% for message in app.flashes('success') %}
                                <div>{{ message }}</div>
                            {% endfor %}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endif %}

                    <form method="POST" action="{{ path('consultation_view') }}" id="consultationForm">
                        <!-- Section 1: Fiche m√©dicale -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-white">Fiche m√©dicale</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="diagnostic"><strong>Diagnostic</strong></label>
                                    <textarea class="form-control" id="diagnostic" name="diagnostic" rows="4" placeholder="Enter the patient's diagnostic...">{{ app.request.get('diagnostic')|default('') }}</textarea>
                                    <small id="diagnostic-feedback" class="d-block mt-2" style="font-size: 0.85rem;"></small>
                                    {% for err in fieldErrors.diagnostic %}
                                        <div class="text-danger" style="font-size:0.95em;">{{ err }}</div>
                                    {% endfor %}
                                </div>
                                <div class="form-group">
                                    <label for="observations"><strong>Observations</strong></label>
                                    <textarea class="form-control" id="observations" name="observations" rows="4" placeholder="Enter any observations...">{{ app.request.get('observations')|default('') }}</textarea>
                                    <small id="observations-feedback" class="d-block mt-2" style="font-size: 0.85rem;"></small>
                                    {% for err in fieldErrors.observations %}
                                        <div class="text-danger" style="font-size:0.95em;">{{ err }}</div>
                                    {% endfor %}
                                </div>
                                <div class="form-group">
                                    <label for="resultatsExamens"><strong>Exam Results</strong></label>
                                    <textarea class="form-control" id="resultatsExamens" name="resultatsExamens" rows="4" placeholder="Enter exam results...">{{ app.request.get('resultatsExamens')|default('') }}</textarea>
                                    <small id="resultatsExamens-feedback" class="d-block mt-2" style="font-size: 0.85rem;"></small>
                                    {% for err in fieldErrors.resultatsExamens %}
                                        <div class="text-danger" style="font-size:0.95em;">{{ err }}</div>
                                    {% endfor %}
                                </div>
                                {# Prescription errors #}
                                {% for err in fieldErrors.prescriptions %}
                                    <div class="text-danger" style="font-size:0.95em;">{{ err }}</div>
                                {% endfor %}
                                {% if fiche is defined and fiche %}
                                    <input type="hidden" name="fiche_id" value="{{ fiche.id }}">
                                    <input type="hidden" id="startTime" name="startTime" value="{{ fiche.startTime ? fiche.startTime|date('Y-m-d H:i:s') : '' }}">
                                {% else %}
                                    <input type="hidden" name="rendezvous_id" value="{{ rendezvousId }}">
                                    <input type="hidden" id="startTime" name="startTime" value="{{ startParam }}">
                                {% endif %}
                                <input type="hidden" name="type" value="Pr√©sentiel">
                                <div class="form-group">
                                    <label for="dureeMinutes"><strong>Duration</strong></label>
                                    <input type="text" class="form-control" id="dureeMinutes" name="dureeMinutes" placeholder="HH:MM:SS" readonly>
                                    <script>
                                    // Visual timer for duration field
                                    (function() {
                                        let startTime = Date.now();
                                        // If startTime is present in hidden input, use it
                                        const startInput = document.getElementById('startTime');
                                        if (startInput && startInput.value) {
                                            const parsed = Date.parse(startInput.value.replace(/-/g, '/'));
                                            if (!isNaN(parsed)) {
                                                startTime = parsed;
                                            }
                                        }
                                        function pad(n) { return n < 10 ? '0' + n : n; }
                                        function updateTimer() {
                                            const now = Date.now();
                                            let diff = Math.floor((now - startTime) / 1000);
                                            if (diff < 0) diff = 0;
                                            const h = Math.floor(diff / 3600);
                                            const m = Math.floor((diff % 3600) / 60);
                                            const s = diff % 60;
                                            document.getElementById('dureeMinutes').value = pad(h) + ':' + pad(m) + ':' + pad(s);
                                        }
                                        setInterval(updateTimer, 1000);
                                        updateTimer();
                                    })();
                                    </script>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Prescription(s) -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 font-weight-bold text-white">Prescription(s)</h6>
                                <button type="button" class="btn btn-sm btn-light" id="addPrescriptionBtn">+ Add prescription</button>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">You can add none, one or several prescriptions linked to this consultation. Leave a row empty to skip it.</p>
                                <div id="prescriptionRows"></div>
                                <script>
                                // Render prescription errors under each field if present
                                document.addEventListener('DOMContentLoaded', function() {
                                    if (typeof fieldErrors !== 'undefined' && Array.isArray(fieldErrors.prescriptions)) {
                                        const rows = document.querySelectorAll('.prescription-row');
                                        fieldErrors.prescriptions.forEach(function(rowErrors, idx) {
                                            if (!rowErrors) return;
                                            const row = rows[idx];
                                            if (!row) return;
                                            // For each field in the row, show errors if present
                                            ['nomMedicament','dose','frequence','duree','instructions'].forEach(function(field) {
                                                if (rowErrors[field] && rowErrors[field].length) {
                                                    const input = row.querySelector(`[name^="prescription_rows[${idx}][${field}]"]`);
                                                    if (input) {
                                                        rowErrors[field].forEach(function(msg) {
                                                            const errDiv = document.createElement('div');
                                                            errDiv.className = 'text-danger';
                                                            errDiv.style.fontSize = '0.95em';
                                                            errDiv.textContent = msg;
                                                            input.parentNode.appendChild(errDiv);
                                                        });
                                                    }
                                                }
                                            });
                                        });
                                    }
                                });
                                </script>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="submit" name="save" class="btn btn-primary">Save consultation (fiche + prescriptions)</button>
                            <button type="button" class="btn btn-secondary" onclick="window.location.href='{{ path('app_fiche_by_staff', {'idStaff': idStaff}) }}'">Cancel</button>
                        </div>
                    </form>

                </div>
                <!-- Jitsi Video Call Section -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-white">Video Call</h6>
                        </div>
                        <div class="card-body">
                            <div id="jitsi-container" style="height: 600px; width: 100%; border: 1px solid #ddd; border-radius: 4px;"></div>
                        </div>
                    </div>

                </div>
                <!-- /.container-fluid -->
                <!-- Bootstrap & jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Jitsi Meet External API -->
    <script src="https://meet.jit.si/external_api.js"></script>

                <!-- /.container-fluid -->
                <!-- Bootstrap core JavaScript-->
    <script src="{{ asset('vendor/jquery/jquery.min.js') }}"></script>
    <script src="{{ asset('vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>

    <!-- Core plugin JavaScript-->
    <script src="{{ asset('vendor/jquery-easing/jquery.easing.min.js') }}"></script>

    <!-- Custom scripts for all pages-->
    <script src="{{ asset('js/sb-admin-2.min.js') }}"></script>

    <!-- JS for dynamic prescription rows (no validation) -->
    <script>
    // Prescription row template
    function createPrescriptionRow(idx, data = {}) {
        return `
        <div class="prescription-row card mb-2 p-3" data-index="${idx}">
            <div class="form-row">
                <div class="form-group col-md-3">
                    <input type="text" class="form-control" name="prescription_rows[${idx}][nomMedicament]" placeholder="Medication name" value="${data.nomMedicament || ''}">
                </div>
                <div class="form-group col-md-2">
                    <input type="text" class="form-control" name="prescription_rows[${idx}][dose]" placeholder="Dose" value="${data.dose || ''}">
                </div>
                <div class="form-group col-md-2">
                    <input type="text" class="form-control" name="prescription_rows[${idx}][frequence]" placeholder="Frequency" value="${data.frequence || ''}">
                </div>
                <div class="form-group col-md-2">
                    <input type="number" min="1" class="form-control" name="prescription_rows[${idx}][duree]" placeholder="Duration (days)" value="${data.duree || ''}">
                </div>
                <div class="form-group col-md-2">
                    <input type="text" class="form-control" name="prescription_rows[${idx}][instructions]" placeholder="Instructions" value="${data.instructions || ''}">
                </div>
                <div class="form-group col-md-1 d-flex align-items-center">
                    <button type="button" class="btn btn-danger btn-sm remove-prescription" title="Remove"><span aria-hidden="true">&times;</span></button>
                </div>
            </div>
        </div>`;
    }

    let prescriptionIdx = 0;
    function addPrescriptionRow(data) {
        const container = document.getElementById('prescriptionRows');
        container.insertAdjacentHTML('beforeend', createPrescriptionRow(prescriptionIdx++, data));
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('addPrescriptionBtn').addEventListener('click', function() {
            addPrescriptionRow();
        });
        document.getElementById('prescriptionRows').addEventListener('click', function(e) {
            if (e.target.closest('.remove-prescription')) {
                e.target.closest('.prescription-row').remove();
            }
        });

        // Optionally, add one empty row by default
        if (prescriptionIdx === 0) addPrescriptionRow();
    });

function initJitsi() {
            const container = document.getElementById('jitsi-container');
            if (!container) {
                console.error('‚ùå Jitsi container not found');
                return;
            }
            try {
                // Generate a unique room name
                const roomName = 'medflow-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
                console.log('üé• Initializing Jitsi with room:', roomName);
                const options = {
                    roomName: roomName,
                    width: '100%',
                    height: 600,
                    parentNode: container,
                    configOverwrite: {
                        startWithAudioMuted: false,
                        startWithVideoMuted: false,
                        disableAudioLevels: false,
                        enableWelcomePage: false
                    },
                    interfaceConfigOverwrite: {
                        MOBILE_APP_PROMO: false,
                        SHOW_JITSI_WATERMARK: false,
                        SHOW_WATERMARK_FOR_GUESTS: false,
                        DEFAULT_BACKGROUND: '#f8f9fa'
                    }
                };
                const api = new JitsiMeetExternalAPI('meet.jit.si', options);
                window.jitsiApi = api;
            } catch (error) {
                console.error('‚ùå Error initializing Jitsi:', error);
            }
        }
        if (typeof JitsiMeetExternalAPI !== 'undefined') {
            initJitsi();
        } else {
            setTimeout(initJitsi, 500);
        }




    </script>
{% endblock %} 