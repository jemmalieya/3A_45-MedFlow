{% extends 'base_dashboard.html.twig' %}
{% block body %}


<div class="container-fluid">

                    <!-- Page Heading -->
                    <h1 class="h3 mb-4 text-gray-800">Consultation Encours </h1>
                    <h6 class="h3 mb-4 text-gray-800">Fiche Medicale </h6>

                    <!-- FicheMedicale Form -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Medical File Information</h6>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ path('consultation_view') }}">
                                <!-- Diagnostic Field -->
                                <div class="form-group">
                                    <label for="diagnostic"><strong>Diagnostic</strong></label>
                                    <textarea class="form-control" id="diagnostic" name="diagnostic" rows="4" placeholder="Enter the patient's diagnostic..." required></textarea>
                                </div>

                                <!-- Observations Field -->
                                <div class="form-group">
                                    <label for="observations"><strong>Observations</strong></label>
                                    <textarea class="form-control" id="observations" name="observations" rows="4" placeholder="Enter any observations..."></textarea>
                                </div>

                                <!-- Resultats Examens Field -->
                                <div class="form-group">
                                    <label for="resultatsExamens"><strong>Exam Results</strong></label>
                                    <textarea class="form-control" id="resultatsExamens" name="resultatsExamens" rows="4" placeholder="Enter exam results..."></textarea>
                                </div>

                                {# Hidden fields: either existing fiche id, or rendezvous/start for a new fiche #}
                                {% if fiche is defined and fiche %}
                                    <input type="hidden" name="fiche_id" value="{{ fiche.id }}">
                                    <input type="hidden" id="startTime" name="startTime" value="{{ fiche.startTime ? fiche.startTime|date('Y-m-d H:i:s') : '' }}">
                                {% else %}
                                    <input type="hidden" name="rendezvous_id" value="{{ rendezvousId }}">
                                    <input type="hidden" id="startTime" name="startTime" value="{{ startParam }}">
                                {% endif %}
                                <!-- Duration (Minutes) Field -->
                                <div class="form-group">
                                    <label for="dureeMinutes"><strong>Duration</strong></label>
                                    <input type="text" class="form-control" id="dureeMinutes" name="dureeMinutes" placeholder="HH:MM:SS" readonly>
                                </div>

                                <!-- Submit Button -->
                                <div class="form-group">
                                    <button type="submit" name="save" class="btn btn-primary">Save Medical File</button>
                                    <button type="button" class="btn btn-secondary" onclick="window.location.href='{{ path('app_fiche_by_staff', {'idStaff': idStaff}) }}'">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
                <!-- /.container-fluid -->
                <!-- Bootstrap core JavaScript-->
    <script src="{{ asset('vendor/jquery/jquery.min.js') }}"></script>
    <script src="{{ asset('vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>

    <!-- Core plugin JavaScript-->
    <script src="{{ asset('vendor/jquery-easing/jquery.easing.min.js') }}"></script>

    <!-- Custom scripts for all pages-->
    <script src="{{ asset('js/sb-admin-2.min.js') }}"></script>

    <script>
        // Live duration updater (reads hidden startTime and updates dureeMinutes)
        (function(){
            const startInput = document.getElementById('startTime');
            const durationInput = document.getElementById('dureeMinutes');
            if (!startInput || !durationInput) return;
            const startVal = startInput.value;
            if (!startVal) return;
            // Convert 'YYYY-MM-DD HH:mm:ss' to ISO
            const iso = startVal.replace(' ', 'T');
            const startDate = new Date(iso);
            if (isNaN(startDate)) return;

            function update() {
                const now = new Date();
                const diffSec = Math.floor((now - startDate) / 1000);
                const hrs = Math.floor(diffSec / 3600);
                const mins = Math.floor((diffSec % 3600) / 60);
                const secs = diffSec % 60;
                const hh = String(hrs).padStart(2, '0');
                const mm = String(mins).padStart(2, '0');
                const ss = String(secs).padStart(2, '0');
                durationInput.value = `${hh}:${mm}:${ss}`;
            }

            update();
            setInterval(update, 1000);
        })();
    </script>
{% endblock %}