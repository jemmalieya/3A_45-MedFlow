{% extends 'base_dashboard.html.twig' %}
{% block title %}Gestion Patients{% endblock %}

{% block body %}
<div class="container-fluid py-4">

  {# ===== HEADER ===== #}
  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-4">
    <div>
      <h1 class="h3 mb-1">Gestion Patients</h1>
      <div class="text-muted">Triage intelligent, alertes & suivi qualit√©</div>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ path('staff_dashboard') }}" class="btn btn-outline-secondary btn-sm">
        ‚Üê Dashboard
      </a>
      <a href="{{ path('staff_patients_index') }}" class="btn btn-light border btn-sm">
        R√©initialiser
      </a>
    </div>
  </div>

  {# ===== FLASHES ===== #}
  {% for m in app.flashes('success') %}<div class="alert alert-success py-2">{{ m }}</div>{% endfor %}
  {% for m in app.flashes('info') %}<div class="alert alert-info py-2">{{ m }}</div>{% endfor %}
  {% for m in app.flashes('danger') %}<div class="alert alert-danger py-2">{{ m }}</div>{% endfor %}

  {# ===== TOP STATS (compact) ===== #}
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">Patients</div>
              <div class="h4 mb-0">{{ stats.total ?? 0 }}</div>
            </div>
            <span class="badge bg-light text-dark border">Total</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">V√©rifi√©s</div>
              <div class="h4 mb-0">{{ stats.verified ?? 0 }}</div>
            </div>
            <span class="badge bg-success">OK</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">Non v√©rifi√©s</div>
              <div class="h4 mb-0">{{ stats.unverified ?? 0 }}</div>
            </div>
            <span class="badge bg-danger">√Ä v√©rifier</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">Critiques</div>
              <div class="h4 mb-0">{{ stats.priorities.CRITIQUE ?? 0 }}</div>
            </div>
            <span class="badge bg-warning text-dark">Priorit√©</span>
          </div>
          {% if (stats.expired_links ?? 0) > 0 %}
            <div class="small text-muted mt-1">{{ stats.expired_links }} lien(s) expir√©(s)</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {# ===== ALERT STRIP (one line, useful) ===== #}
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body py-3">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="fw-semibold">Alertes :</span>

        <span class="badge bg-light text-dark border">
          T√©l√©phones invalides: <span class="fw-semibold">{{ stats.phone_invalid ?? 0 }}</span>
        </span>

        <span class="badge bg-light text-dark border">
          Comptes bloqu√©s: <span class="fw-semibold">{{ stats.blocked ?? 0 }}</span>
        </span>

        <span class="badge bg-light text-dark border">
          Haute: <span class="fw-semibold">{{ stats.priorities.HAUTE ?? 0 }}</span>
        </span>

        <span class="badge bg-light text-dark border">
          Moyenne: <span class="fw-semibold">{{ stats.priorities.MOYENNE ?? 0 }}</span>
        </span>

        <span class="ms-auto small text-muted">
          Conseil: {% if (stats.unverified ?? 0) > 0 %}relancer les non v√©rifi√©s{% else %}situation saine{% endif %}
        </span>
      </div>
    </div>
  </div>

  {# ===== FILTER BAR (compact, 1 row) ===== #}
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <form method="get" class="row g-2 align-items-center">

        <div class="col-12 col-lg-4">
          <div class="input-group">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input type="text" name="q" value="{{ q }}" class="form-control"
                   placeholder="Rechercher CIN, nom, pr√©nom, email...">
          </div>
        </div>

        {# Triage rapide (plus pro que 5 selects) #}
        <div class="col-6 col-lg-3">
          <select name="alert" class="form-select">
            <option value="" {{ alert == '' ? 'selected' : '' }}>Triage rapide : Tout</option>
            <option value="unverified" {{ alert == 'unverified' ? 'selected' : '' }}>√Ä v√©rifier : Non v√©rifi√©s</option>
            <option value="unverified_expired" {{ alert == 'unverified_expired' ? 'selected' : '' }}>Urgent : Lien expir√©</option>
            <option value="phone_invalid" {{ alert == 'phone_invalid' ? 'selected' : '' }}>Qualit√© : T√©l√©phone invalide</option>
            <option value="blocked" {{ alert == 'blocked' ? 'selected' : '' }}>S√©curit√© : Comptes bloqu√©s</option>
          </select>
        </div>

        <div class="col-6 col-lg-2">
          <select name="triage" class="form-select">
            <option value="" {{ triage == '' ? 'selected' : '' }}>Priorit√© : Toutes</option>
            <option value="CRITIQUE" {{ triage == 'CRITIQUE' ? 'selected' : '' }}>Critique</option>
            <option value="HAUTE" {{ triage == 'HAUTE' ? 'selected' : '' }}>Haute</option>
            <option value="MOYENNE" {{ triage == 'MOYENNE' ? 'selected' : '' }}>Moyenne</option>
            <option value="OK" {{ triage == 'OK' ? 'selected' : '' }}>OK</option>
          </select>
        </div>

        <div class="col-6 col-lg-2">
          <select name="sort" class="form-select">
            <option value="recent" {{ sort == 'recent' ? 'selected' : '' }}>Tri : r√©cents</option>
            <option value="name" {{ sort == 'name' ? 'selected' : '' }}>Tri : nom (A-Z)</option>
            <option value="cin" {{ sort == 'cin' ? 'selected' : '' }}>Tri : CIN</option>
          </select>
        </div>

        <div class="col-6 col-lg-1 d-grid">
          <button class="btn btn-primary">Go</button>
        </div>
      </form>

      {% if q or triage != '' or alert != '' %}
        <div class="small text-muted mt-2">
          Actif :
          {% if q %}<span class="badge bg-light text-dark border">Recherche</span>{% endif %}
          {% if triage != '' %}<span class="badge bg-light text-dark border">Priorit√© {{ triage }}</span>{% endif %}
          {% if alert != '' %}<span class="badge bg-light text-dark border">Triage</span>{% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  {# ===== TABLE (clean) ===== #}
  <div class="card border-0 shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:110px;">CIN</th>
            <th>Patient</th>
            <th style="width:170px;">T√©l√©phone</th>
            <th>Email</th>
            <th style="width:120px;">Priorit√©</th>
            <th style="width:140px;">Statut</th>
            <th class="text-end" style="width:120px;">Action</th>
          </tr>
        </thead>

        <tbody>
        {% for row in rows %}
          {% set p = row.p %}
          {% set t = row.triage %}

          <tr>
            <td class="text-muted">{{ p.cin }}</td>

            <td>
              <div class="fw-semibold">{{ p.nom }} {{ p.prenom }}</div>
              <div class="text-muted small">
                {% if t.alerts is empty %}
                  Aucun signal
                {% else %}
                  {# icones compactes #}
                  {% for a in t.alerts %}
                    {% if a.key == 'blocked' %}
                      <span class="me-1">üîí</span>
                    {% elseif a.key == 'phone_invalid' %}
                      <span class="me-1">üìµ</span>
                    {% elseif a.key == 'unverified_expired' %}
                      <span class="me-1">‚è≥</span>
                    {% elseif a.key == 'unverified' %}
                      <span class="me-1">‚úâÔ∏è</span>
                    {% endif %}
                  {% endfor %}
                  <span class="ms-1">alertes</span>
                {% endif %}
              </div>
            </td>

            <td>
              {% if p.telephoneUser %}
                <span class="{{ t.phoneOk ? '' : 'text-danger fw-semibold' }}">
                  {{ p.telephoneUser }}
                </span>
              {% else %}
                <span class="text-danger fw-semibold">‚Äî</span>
              {% endif %}
            </td>

            <td><a href="mailto:{{ p.emailUser }}">{{ p.emailUser }}</a></td>

            <td>
              {# priorit√© pill #}
              {% if t.priority.level == 'CRITIQUE' %}
                <span class="badge bg-danger">Critique</span>
              {% elseif t.priority.level == 'HAUTE' %}
                <span class="badge bg-warning text-dark">Haute</span>
              {% elseif t.priority.level == 'MOYENNE' %}
                <span class="badge bg-info text-dark">Moyenne</span>
              {% else %}
                <span class="badge bg-success">OK</span>
              {% endif %}
            </td>

            <td>
              {% if p.isVerified %}
                <span class="badge bg-success">V√©rifi√©</span>
              {% else %}
                <span class="badge bg-danger">Non v√©rifi√©</span>
              {% endif %}
              {% if t.blocked %}
                <span class="badge bg-dark ms-1">Bloqu√©</span>
              {% endif %}
            </td>

            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary"
                 href="{{ path('staff_patients_show', {id: p.id}) }}">
                Voir
              </a>
            </td>
          </tr>

        {% else %}
          <tr>
            <td colspan="7" class="text-center py-5 text-muted">
              Aucun patient ne correspond aux filtres.
              <div class="mt-2">
                <a class="btn btn-sm btn-outline-secondary" href="{{ path('staff_patients_index') }}">
                  R√©initialiser
                </a>
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>

      </table>
    </div>
  </div>

</div>
{% endblock %}
