{% extends 'base_dashboard.html.twig' %}
{% block title %}Statistiques Patients{% endblock %}

{% block body %}
<div class="container-fluid py-4">

  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-4">
    <div>
      <h1 class="h3 mb-1">Statistiques Patients</h1>
      <div class="text-muted">Vue d√©cisionnelle ‚Äî priorit√©s, v√©rification, qualit√©</div>
    </div>

    <div class="d-flex gap-2">
      <a href="{{ path('staff_patients_index') }}" class="btn btn-outline-secondary btn-sm">‚Üê Retour</a>
      <a href="{{ path('staff_patients_report_pdf') }}" class="btn btn-primary btn-sm">T√©l√©charger PDF</a>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-md-3"><div class="card border-0 shadow-sm"><div class="card-body">
      <div class="text-muted small">Total</div><div class="h3 mb-0">{{ stats.total }}</div>
    </div></div></div>
    <div class="col-12 col-md-3"><div class="card border-0 shadow-sm"><div class="card-body">
      <div class="text-muted small">V√©rifi√©s</div><div class="h3 mb-0">{{ stats.verified }}</div>
    </div></div></div>
    <div class="col-12 col-md-3"><div class="card border-0 shadow-sm"><div class="card-body">
      <div class="text-muted small">Non v√©rifi√©s</div><div class="h3 mb-0">{{ stats.unverified }}</div>
    </div></div></div>
    <div class="col-12 col-md-3"><div class="card border-0 shadow-sm"><div class="card-body">
      <div class="text-muted small">Alertes (qualit√©)</div>
      <div class="small">
        üìµ {{ stats.phone_invalid }} tel invalides ‚Ä¢ üîí {{ stats.blocked }} bloqu√©s ‚Ä¢ ‚è≥ {{ stats.expired_links }} expir√©s
      </div>
    </div></div></div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="fw-semibold mb-2">Priorit√©s</div>
          <canvas id="chartPriorities" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="fw-semibold mb-2">V√©rification</div>
          <canvas id="chartVerification" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="fw-semibold mb-2">Qualit√© & S√©curit√© (anomalies)</div>
          <canvas id="chartQuality" height="90"></canvas>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="fw-semibold mb-2">Conseils automatiques</div>
          <ul class="mb-0">
            {% for t in tips %}
              <li>{{ t }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>

{# Chart.js CDN #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const priorities = {{ chartPriorities|json_encode|raw }};
  const verification = {{ chartVerification|json_encode|raw }};
  const quality = {{ chartDataQuality|json_encode|raw }};

  new Chart(document.getElementById('chartPriorities'), {
    type: 'bar',
    data: {
      labels: ['Critique', 'Haute', 'Moyenne', 'OK'],
      datasets: [{ label: 'Patients', data: priorities }]
    }
  });

  new Chart(document.getElementById('chartVerification'), {
    type: 'doughnut',
    data: {
      labels: ['V√©rifi√©s', 'Non v√©rifi√©s'],
      datasets: [{ label: 'Comptes', data: verification }]
    }
  });

  new Chart(document.getElementById('chartQuality'), {
    type: 'bar',
    data: {
      labels: ['T√©l√©phones invalides', 'Comptes bloqu√©s', 'Liens expir√©s'],
      datasets: [{ label: 'Alertes', data: quality }]
    }
  });
</script>
{% endblock %}
