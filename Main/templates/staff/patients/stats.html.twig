{% extends 'base_dashboard.html.twig' %}

{% block title %}Statistiques des Patients{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <!-- ===== HEADER ===== -->
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-4">
        <div>
            <h1 class="h3 mb-1">Statistiques des Patients</h1>
            <div class="text-muted">Vue d√©cisionnelle ‚Äî priorit√©s, v√©rification, qualit√©</div>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ path('staff_patients_index') }}" class="btn btn-outline-secondary btn-sm">‚Üê Retour</a>
            <a href="{{ path('staff_patients_report_pdf') }}" class="btn btn-primary btn-sm">T√©l√©charger PDF</a>
        </div>
    </div>

    <!-- ===== STATS CARDS SECTION ===== -->
    <div class="row g-3 mb-4">
        <!-- Total Patients -->
        <div class="col-12 col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="text-muted small">Total des Patients</div>
                    <div class="h3 mb-0">{{ stats.total }}</div>
                </div>
            </div>
        </div>

        <!-- Verified Patients -->
        <div class="col-12 col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="text-muted small">V√©rifi√©s</div>
                    <div class="h3 mb-0">{{ stats.verified }}</div>
                </div>
            </div>
        </div>

        <!-- Unverified Patients -->
        <div class="col-12 col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="text-muted small">Non V√©rifi√©s</div>
                    <div class="h3 mb-0">{{ stats.unverified }}</div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="col-12 col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="text-muted small">Alertes (Qualit√©)</div>
                    <div class="small">
                        üìµ {{ stats.phone_invalid }} T√©l√©phones invalides ‚Ä¢ üîí {{ stats.blocked }} Bloqu√©s ‚Ä¢ ‚è≥ {{ stats.expired_links }} Liens expir√©s
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CHARTS SECTION ===== -->
    <div class="row g-3">
        <!-- Priorities Chart -->
        <div class="col-12 col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="fw-semibold mb-2">Priorit√©s des Patients</div>
                    <canvas id="chartPriorities" style="max-height: 300px; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>

        <!-- Verification Chart -->
        <div class="col-12 col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="fw-semibold mb-2">V√©rification des Patients</div>
                    <canvas id="chartVerification" style="max-height: 300px; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>

        <!-- Quality & Alerts Chart -->
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="fw-semibold mb-2">Qualit√© & S√©curit√© des Donn√©es</div>
                    <canvas id="chartQuality" style="max-height: 300px; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== ACTIONABLE TIPS SECTION ===== -->
    <div class="row g-3">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="fw-semibold mb-2">Conseils Automatiques</div>
                    <ul class="mb-0">
                        {% for t in tips %}
                            <li>{{ t }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

</div>

{# Chart.js CDN #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const priorities = {{ chartPriorities|json_encode|raw }};
  const verification = {{ chartVerification|json_encode|raw }};
  const quality = {{ chartDataQuality|json_encode|raw }};

  // Priorities Bar Chart
  new Chart(document.getElementById('chartPriorities'), {
    type: 'bar',
    data: {
      labels: ['Critique', 'Haute', 'Moyenne', 'OK'],
      datasets: [{ label: 'Patients', data: priorities }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 1.5,
    }
  });

  // Verification Doughnut Chart
  new Chart(document.getElementById('chartVerification'), {
    type: 'doughnut',
    data: {
      labels: ['V√©rifi√©s', 'Non V√©rifi√©s'],
      datasets: [{ label: 'Comptes', data: verification }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 1.2,
    }
  });

  // Quality & Alerts Bar Chart
  new Chart(document.getElementById('chartQuality'), {
    type: 'bar',
    data: {
      labels: ['T√©l√©phones Invalides', 'Comptes Bloqu√©s', 'Liens Expir√©s'],
      datasets: [{ label: 'Alertes', data: quality }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 1.5,
    }
  });
</script>
{% endblock %}
