{% extends 'base_dashboard.html.twig' %}

{% block body %}
<div class="container mt-5">
    <h2 class="mb-4 text-primary"><i class="fas fa-chart-pie me-2"></i>Statistiques des Durées des Rendez-vous</h2>
    <div class="mb-3">
        <a href="{{ path('app_stats_pdf', {'idStaff': doctor.id}) }}" class="btn btn-primary btn-lg shadow">
            <i class="fas fa-file-pdf me-2"></i>Exporter en PDF
        </a>
    </div>
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow border-0">
                <div class="card-body text-center">
                    <h6 class="text-muted">Nombre de rendez-vous</h6>
                    <h2 class="text-info fw-bold">{{ count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow border-0">
                <div class="card-body text-center">
                    <h6 class="text-muted">Durée moyenne</h6>
                    <h2 class="text-success fw-bold">{{ average|number_format(2) }} min</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow border-0">
                <div class="card-body text-center">
                    <h6 class="text-muted">Durée max / min</h6>
                    <h2 class="fw-bold"><span class="text-danger">{{ max|number_format(2) }}</span> / <span class="text-secondary">{{ min|number_format(2) }}</span> min</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="card mb-4 shadow border-0">
        <div class="card-body">
            <h5 class="card-title mb-4">Médecin : <span class="text-primary">Dr. {{ doctor.nom }} {{ doctor.prenom }}</span></h5>
            <div class="row">
                <div class="col-lg-7 mb-4 mb-lg-0">
                    <div class="mb-3">
                        <canvas id="durationChart" height="120"></canvas>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="mb-3">
                        <canvas id="pieChart" height="120"></canvas>
                    </div>
                    <div class="mb-3">
                        <canvas id="modePieChart" height="120"></canvas>
                    </div>
                </div>
            </div>
            <a href="{{ path('app_fiche_by_staff', {'idStaff': doctor.id}) }}" class="btn btn-outline-primary mt-3"><i class="fas fa-arrow-left me-1"></i>Retour à mes consultations</a>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<!-- Chart.js must be loaded before any custom chart scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const durations = {{ durations|json_encode|raw }};
    // Bar chart for each consultation
    const durationCtx = document.getElementById('durationChart').getContext('2d');
    const durationChart = new Chart(durationCtx, {
        type: 'bar',
        data: {
            labels: durations.map((_, i) => 'Consultation #' + (i + 1)),
            datasets: [{
                label: 'Durée (min)',
                data: durations,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                borderRadius: 6,
                hoverBackgroundColor: 'rgba(54, 162, 235, 0.8)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Durée de chaque rendez-vous',
                    font: { size: 18 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Durée: ' + context.parsed.y + ' min';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Durée (minutes)'
                    },
                    grid: { color: '#e3e3e3' }
                },
                x: {
                    grid: { color: '#f5f5f5' }
                }
            }
        }
    });

    // Pie chart for duration distribution (short, medium, long)
    const durationPieCtx = document.getElementById('pieChart').getContext('2d');
    const short = durations.filter(d => d < 15).length;
    const medium = durations.filter(d => d >= 15 && d < 30).length;
    const long = durations.filter(d => d >= 30).length;
    const durationPieChart = new Chart(durationPieCtx, {
        type: 'pie',
        data: {
            labels: ['Courte (< 15 min)', 'Moyenne (15-30 min)', 'Longue (≥ 30 min)'],
            datasets: [{
                data: [short, medium, long],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(255, 205, 86, 0.7)',
                    'rgba(255, 99, 132, 0.7)'
                ],
                borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(255, 99, 132, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: { font: { size: 14 } }
                },
                title: {
                    display: true,
                    text: 'Répartition des durées',
                    font: { size: 18 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            return label + ': ' + value + ' consultations';
                        }
                    }
                }
            }
        }
    });

    // Pie chart for mode distribution (Présentiel vs Distanciel)
    const modePieCtx = document.getElementById('modePieChart').getContext('2d');
    const modeCounts = {{ modeCounts|json_encode|raw }};
    const modeLabels = Object.keys(modeCounts);
    const modeData = Object.values(modeCounts);
    const modePieChart = new Chart(modePieCtx, {
        type: 'pie',
        data: {
            labels: modeLabels,
            datasets: [{
                data: modeData,
                backgroundColor: [
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(201, 203, 207, 0.7)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(201, 203, 207, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: { font: { size: 14 } }
                },
                title: {
                    display: true,
                    text: 'Répartition par mode',
                    font: { size: 18 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            return label + ': ' + value + ' consultations';
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
