{% extends 'base_dashboard.html.twig' %}
{% block title %}Admin BI{% endblock %}

{% block body %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">üìä Tableau de bord d√©cisionnel</h3>

    <div class="btn-group">
      <a class="btn btn-outline-dark {{ days == 7 ? 'active' : '' }}" href="{{ path('admin_bi_dashboard', {days: 7}) }}">7j</a>
      <a class="btn btn-outline-dark {{ days == 30 ? 'active' : '' }}" href="{{ path('admin_bi_dashboard', {days: 30}) }}">30j</a>
      <a class="btn btn-outline-dark {{ days == 90 ? 'active' : '' }}" href="{{ path('admin_bi_dashboard', {days: 90}) }}">90j</a>
    </div>
  </div>

  {# ‚úÖ ALERTES #}
  {% for a in alerts %}
    <div class="alert alert-{{ a.type }} shadow-sm">
      <strong>{{ a.title }}</strong> ‚Äî {{ a.message }}
    </div>
  {% endfor %}

  {# ‚úÖ KPI (Mis √† jour - pas d'annulation) #}
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted">CA Total</div>
        <div class="fs-4 fw-bold">{{ kpi.caTotal|number_format(2,'.',' ') }} DT</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted">CA ({{ days }} jours)</div>
        <div class="fs-4 fw-bold">{{ kpi.caPeriode|number_format(2,'.',' ') }} DT</div>

        <div class="mt-2 small">
          {% if kpi.variationCA is null %}
            <span class="text-muted">Comparaison indisponible</span>
          {% else %}
            {% if kpi.variationCA < 0 %}
              <span class="text-danger fw-bold">‚Üì {{ (kpi.variationCA|abs)|number_format(1,'.',' ') }}%</span>
              <span class="text-muted"> vs p√©riode pr√©c√©dente</span>
            {% else %}
              <span class="text-success fw-bold">‚Üë {{ kpi.variationCA|number_format(1,'.',' ') }}%</span>
              <span class="text-muted"> vs p√©riode pr√©c√©dente</span>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted">Panier moyen</div>
        <div class="fs-4 fw-bold">{{ kpi.panierMoyen|number_format(2,'.',' ') }} DT</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted">Commandes en attente</div>
        <div class="fs-4 fw-bold">{{ kpi.nbEnAttente }}</div>
        <div class="small text-muted mt-1">sur {{ days }} jours</div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted">Taux de rupture</div>
        <div class="fs-4 fw-bold">{{ kpi.tauxRupture|number_format(1,'.',' ') }}%</div>
        <div class="small text-muted mt-1">produits en "Rupture"</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted">Commandes (Total)</div>
        <div class="fs-4 fw-bold">{{ kpi.nbTotal }}</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted">Commandes ({{ days }} jours)</div>
        <div class="fs-4 fw-bold">{{ kpi.nbPeriode }}</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted">Objectif BI</div>
        <div class="fw-bold mt-2">Stock + Ventes + Statuts</div>
        <div class="small text-muted">Alertes & recommandations automatiques</div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-7">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">üìà Chiffre d‚Äôaffaires ({{ days }} jours)</h5>
        <canvas id="chartCA" height="110"></canvas>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">üç© Commandes par statut</h5>
        <canvas id="chartStatuts" height="220"></canvas>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">üìä Top produits vendus</h5>
        <canvas id="chartTop" height="200"></canvas>

        <div class="mt-3">
          <ul class="list-group">
            {% for p in topProduits %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{ p.produit }}</span>
                <strong>{{ p.qte }}</strong>
              </li>
            {% else %}
              <li class="list-group-item text-muted">Aucune donn√©e</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">‚ö†Ô∏è Produits en stock bas</h5>

        {% if stocksBas is empty %}
          <div class="text-muted">Aucun produit critique ‚úÖ</div>
        {% else %}
          <ul class="list-group">
            {% for s in stocksBas %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{ s.nom_produit }}</span>
                <strong>{{ s.quantite_produit }}</strong>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </div>

    <div class="col-lg-12">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">üß† Conseils automatiques</h5>
        <ul class="list-group">
          {% for t in tips %}
            <li class="list-group-item">{{ t }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const caLabels = {{ charts.ca.labels|json_encode|raw }};
  const caValues = {{ charts.ca.values|json_encode|raw }};

  const stLabels = {{ charts.statuts.labels|json_encode|raw }};
  const stValues = {{ charts.statuts.values|json_encode|raw }};

  const topLabels = {{ charts.top.labels|json_encode|raw }};
  const topValues = {{ charts.top.values|json_encode|raw }};

  new Chart(document.getElementById('chartCA'), {
    type: 'line',
    data: { labels: caLabels, datasets: [{ label: 'CA (DT)', data: caValues, tension: 0.3 }] },
    options: { responsive: true }
  });

  new Chart(document.getElementById('chartStatuts'), {
    type: 'doughnut',
    data: { labels: stLabels, datasets: [{ data: stValues }] },
    options: { responsive: true }
  });

  new Chart(document.getElementById('chartTop'), {
    type: 'bar',
    data: { labels: topLabels, datasets: [{ label: 'Quantit√©', data: topValues }] },
    options: { responsive: true }
  });
</script>
{% endblock %}
