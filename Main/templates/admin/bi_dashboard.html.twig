{% extends 'base_dashboard.html.twig' %}
{% block title %}Tableau de bord BI{% endblock %}

{% block head %}
<style>
  /* ====== BI THEME (Lisibilité + neutre, pas rouge/vert agressif) ====== */
  :root{
    --bi-text: #111827;          /* noir lisible */
    --bi-muted: #4b5563;         /* gris lisible */
    --bi-border: #e5e7eb;        /* border clean */
    --bi-bg: #ffffff;
    --bi-soft: #f8fafc;

    --bi-blue: #2563eb;
    --bi-blue-soft: #eff6ff;

    --bi-amber: #b45309;
    --bi-amber-soft: #fff7ed;

    --bi-slate: #334155;
    --bi-slate-soft: #f1f5f9;
  }

  /* Texte global */
  .container-fluid { color: var(--bi-text); }
  .text-muted { color: var(--bi-muted) !important; }
  h3,h4,h5 { color: var(--bi-text) !important; }

  /* Cards plus propres */
  .card{
    background: var(--bi-bg);
    border: 1px solid var(--bi-border) !important;
    border-radius: 14px;
    box-shadow: 0 10px 24px rgba(17, 24, 39, 0.06);
    overflow: hidden;
  }
  .card-header{
    background: var(--bi-bg) !important;
    border-bottom: 1px solid var(--bi-border) !important;
  }
  .card-body.bg-light{ background: var(--bi-soft) !important; }

  /* KPI cards */
  .kpi-card{ transition: transform .18s ease, box-shadow .18s ease; }
  .kpi-card:hover{
    transform: translateY(-2px);
    box-shadow: 0 14px 32px rgba(17, 24, 39, 0.10);
  }

  /* Boutons 7/30/90 plus clean */
  .btn-outline-primary{
    border-color: #c7d2fe;
    color: #1d4ed8;
  }
  .btn-outline-primary:hover{ background: #eef2ff; }
  .btn-outline-primary.active{
    background: #1d4ed8 !important;
    border-color: #1d4ed8 !important;
    color: #fff !important;
  }

  /* Badge général */
  .badge{
    border-radius: 999px;
    padding: .45rem .75rem;
    font-weight: 800;
    letter-spacing: .2px;
  }

  /* Chips catégorie (plus clean, lisible) */
  .chip-cat{
    background: #f8fafc;
    border: 1px solid var(--bi-border);
    color: var(--bi-slate);
    padding: .35rem .60rem;
    border-radius: 999px;
    font-weight: 700;
    font-size: .85rem;
    display: inline-block;
  }

  /* Tables : titres noirs + meilleur spacing */
  .table-produits{ margin: 0; }
  .table-produits thead th{
    color: var(--bi-text) !important;
    font-weight: 900 !important;
    font-size: .82rem !important;
    text-transform: uppercase;
    letter-spacing: .35px;
    background: #fbfdff !important;
    border-bottom: 1px solid var(--bi-border) !important;
    padding: 14px 14px !important;
    white-space: nowrap;
  }
  .table-produits tbody td{
    color: var(--bi-text);
    font-size: .95rem;
    padding: 14px 14px !important;
    border-color: var(--bi-border) !important;
    vertical-align: middle;
  }
  .table-hover tbody tr:hover{ background: #f9fafb !important; }

  /* Valeurs importantes */
  .val-qty{
    font-weight: 900;
    color: var(--bi-blue);
  }
  .val-ca{
    font-weight: 800;
    color: var(--bi-slate);
  }

  /* Badges STOCK neutres (pas rouge/vert) */
  .stock-pill{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: .40rem .70rem;
    border-radius: 999px;
    font-weight: 900;
    font-size: .85rem;
    border: 1px solid var(--bi-border);
    background: var(--bi-slate-soft);
    color: var(--bi-slate);
  }
  .stock-pill::before{
    content: "";
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #94a3b8;
    display: inline-block;
  }
  /* niveaux (soft) */
  .stock-ok{ background: var(--bi-blue-soft); border-color: #bfdbfe; color: var(--bi-blue); }
  .stock-ok::before{ background: #60a5fa; }

  .stock-mid{ background: var(--bi-amber-soft); border-color: #fed7aa; color: var(--bi-amber); }
  .stock-mid::before{ background: #fb923c; }

  .stock-low{ background: var(--bi-slate-soft); border-color: #cbd5e1; color: #0f172a; }
  .stock-low::before{ background: #64748b; }

  /* Badge STATUT neutre */
  .status-pill{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: .40rem .70rem;
    border-radius: 999px;
    font-weight: 900;
    font-size: .85rem;
    border: 1px solid var(--bi-border);
    background: var(--bi-slate-soft);
    color: #0f172a;
  }
  .status-pill::before{
    content: "";
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #64748b;
    display: inline-block;
  }
  /* Statuts soft (pas rouge/vert) */
  .status-rupture{ background: #f1f5f9; border-color: #cbd5e1; color: #0f172a; }
  .status-rupture::before{ background: #0f172a; }

  .status-dispo{ background: var(--bi-blue-soft); border-color: #bfdbfe; color: var(--bi-blue); }
  .status-dispo::before{ background: #2563eb; }

  .status-autre{ background: var(--bi-amber-soft); border-color: #fed7aa; color: var(--bi-amber); }
  .status-autre::before{ background: #fb923c; }

  /* Variation badge (si tu gardes) */
  .variation-badge{ font-size: .85rem; font-weight: 900; padding: .40rem .65rem; }
  
</style>
{% endblock %}

{% block body %}
<div class="container-fluid py-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0 fw-bold">Tableau de bord BI</h3>
    <div class="btn-group">
      {# (ici tu peux garder comme tu as) #}
      <a class="btn btn-sm btn-outline-primary {{ days == 7 ? 'active' : '' }}" href="{{ path('admin_bi_dashboard', {days: 7, cat: cat}) }}">7 jours</a>
      <a class="btn btn-sm btn-outline-primary {{ days == 30 ? 'active' : '' }}" href="{{ path('admin_bi_dashboard', {days: 30, cat: cat}) }}">30 jours</a>
      <a class="btn btn-sm btn-outline-primary {{ days == 90 ? 'active' : '' }}" href="{{ path('admin_bi_dashboard', {days: 90, cat: cat}) }}">90 jours</a>
    </div>
  </div>

  {# Filtres #}
  <form method="get" class="card mb-4 shadow-sm border-0">
    <div class="card-body bg-light">
      <div class="row g-3 align-items-end">
        <input type="hidden" name="days" value="{{ days }}">

        <div class="col-md-3">
          <label class="form-label fw-bold">Date de début</label>
          <input type="date" name="from" class="form-control" value="{{ from }}" required>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-bold">Date de fin</label>
          <input type="date" name="to" class="form-control" value="{{ to }}" required>
        </div>

        <div class="col-md-4">
          <label class="form-label fw-bold">Catégorie</label>
          <select name="cat" class="form-select">
            <option value="">Toutes les catégories</option>
            {% for c in categories %}
              <option value="{{ c }}" {{ cat == c ? 'selected' : '' }}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2 d-flex gap-2">
          <button class="btn btn-primary flex-fill" type="submit">
            <i class="bi bi-funnel-fill"></i> Filtrer
          </button>
          <a class="btn btn-outline-secondary" href="{{ path('admin_bi_dashboard', {days: days}) }}" title="Réinitialiser">
            <i class="bi bi-arrow-clockwise"></i>
          </a>
        </div>
      </div>

      <div class="mt-3">
        <span class="badge bg-dark">
          Période : {{ from }} au {{ to }}
          {% if cat %} | Catégorie : {{ cat }}{% endif %}
        </span>
      </div>
    </div>
  </form>

  {# Alertes #}
  {% if alerts is not empty %}
    <div class="mb-4">
      {% for a in alerts %}
        <div class="alert alert-{{ a.type }} alert-dismissible fade show mb-2 border-0 shadow-sm" role="alert">
          <strong>{{ a.title }}</strong> — {{ a.message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# KPI principaux (inchangé) #}
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100 kpi-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-semibold small">Chiffre d'affaires</p>
              <h3 class="mb-0 fw-bold">{{ kpi.ca|number_format(2, ',', ' ') }} DT</h3>
            </div>
            <div class="bg-primary bg-opacity-10 p-2 rounded-circle">
              <i class="bi bi-currency-dollar text-primary fs-4"></i>
            </div>
          </div>
          {% if kpi.variationCA is not null %}
            <span class="variation-badge badge {% if kpi.variationCA < 0 %}bg-danger{% else %}bg-success{% endif %}">
              <i class="bi bi-arrow-{{ kpi.variationCA < 0 ? 'down' : 'up' }}"></i>
              {{ kpi.variationCA|abs|number_format(1, ',', ' ') }}%
            </span>
            <small class="text-muted ms-1">vs période précédente</small>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100 kpi-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-semibold small">Nombre de commandes</p>
              <h3 class="mb-0 fw-bold">{{ kpi.nbCommandes }}</h3>
            </div>
            <div class="bg-success bg-opacity-10 p-2 rounded-circle">
              <i class="bi bi-cart-check text-success fs-4"></i>
            </div>
          </div>
          {% if kpi.variationCommandes is not null %}
            <span class="variation-badge badge {% if kpi.variationCommandes < 0 %}bg-danger{% else %}bg-success{% endif %}">
              <i class="bi bi-arrow-{{ kpi.variationCommandes < 0 ? 'down' : 'up' }}"></i>
              {{ kpi.variationCommandes|abs|number_format(1, ',', ' ') }}%
            </span>
            <small class="text-muted ms-1">vs période précédente</small>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100 kpi-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-semibold small">Panier moyen</p>
              <h3 class="mb-0 fw-bold">{{ kpi.panierMoyen|number_format(2, ',', ' ') }} DT</h3>
            </div>
            <div class="bg-info bg-opacity-10 p-2 rounded-circle">
              <i class="bi bi-basket text-info fs-4"></i>
            </div>
          </div>
          {% if kpi.variationPanier is not null %}
            <span class="variation-badge badge {% if kpi.variationPanier < 0 %}bg-danger{% else %}bg-success{% endif %}">
              <i class="bi bi-arrow-{{ kpi.variationPanier < 0 ? 'down' : 'up' }}"></i>
              {{ kpi.variationPanier|abs|number_format(1, ',', ' ') }}%
            </span>
            <small class="text-muted ms-1">vs période précédente</small>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100 kpi-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <p class="text-muted mb-1 fw-semibold small">Taux de conversion</p>
              <h3 class="mb-0 fw-bold">{{ kpi.tauxConversion|number_format(1, ',', ' ') }}%</h3>
            </div>
            <div class="bg-warning bg-opacity-10 p-2 rounded-circle">
              <i class="bi bi-graph-up text-warning fs-4"></i>
            </div>
          </div>
          <small class="text-muted">{{ kpi.nbValidees }} / {{ kpi.nbCommandes }} validées</small>
        </div>
      </div>
    </div>
  </div>

  {# KPI secondaires (inchangé) #}
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1 fw-semibold small">Quantité totale vendue</p>
          <h4 class="mb-0 fw-bold">{{ kpi.quantiteTotale }} <small class="text-muted fw-normal">unités</small></h4>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1 fw-semibold small">Commandes en attente</p>
          <h4 class="mb-0 fw-bold">{{ kpi.nbEnAttente }}</h4>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1 fw-semibold small">Taux de rupture</p>
          <h4 class="mb-0 fw-bold {% if kpi.tauxRupture >= 10 %}text-danger{% elseif kpi.tauxRupture >= 5 %}text-warning{% else %}text-success{% endif %}">
            {{ kpi.tauxRupture|number_format(1, ',', ' ') }}%
          </h4>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1 fw-semibold small">Période analysée</p>
          <h4 class="mb-0 fw-bold">{{ days }} <small class="text-muted fw-normal">jours</small></h4>
        </div>
      </div>
    </div>
  </div>

  {# Graphique principal (inchangé) #}
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-1 fw-bold">Évolution quotidienne des ventes</h5>
          <small class="text-muted">
            CA et quantités vendues par jour
            {% if cat %} - Catégorie : <strong>{{ cat }}</strong>{% endif %}
          </small>
        </div>
        <div class="card-body">
          <canvas id="chartVentesJour" height="80"></canvas>
        </div>
      </div>
    </div>
  </div>

  {# Graphiques secondaires (inchangé) #}
  <div class="row g-3 mb-4">
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-bold">Performance par catégorie</h5>
          <small class="text-muted">Quantités et CA par catégorie</small>
        </div>
        <div class="card-body">
          <canvas id="chartCategories" height="100"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-bold">Répartition par statut</h5>
          <small class="text-muted">Distribution des commandes</small>
        </div>
        <div class="card-body">
          <canvas id="chartStatuts" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  {# Tables #}
  <div class="row g-3 mb-4">
    <div class="col-lg-7">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-bold">Top 10 des produits</h5>
          <small class="text-muted">Produits les plus vendus sur la période</small>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-produits mb-0">
              <thead class="table-light">
                <tr>
                  <th>Produit</th>
                  <th>Catégorie</th>
                  <th class="text-end">Quantité</th>
                  <th class="text-end">CA (DT)</th>
                  <th class="text-center">Stock actuel</th>
                </tr>
              </thead>
              <tbody>
                {% for p in topProduits %}
                  {% set stockClass = (p.stock_actuel >= 11) ? 'stock-ok' : (p.stock_actuel >= 5 ? 'stock-mid' : 'stock-low') %}
                  <tr>
                    <td class="fw-semibold">{{ p.produit }}</td>
                    <td><span class="chip-cat">{{ p.categorie }}</span></td>
                    <td class="text-end val-qty">{{ p.quantite }}</td>
                    <td class="text-end val-ca">{{ p.ca|number_format(0, ',', ' ') }}</td>
                    <td class="text-center">
                      <span class="stock-pill {{ stockClass }}">{{ p.stock_actuel }}</span>
                    </td>
                  </tr>
                {% else %}
                  <tr><td colspan="5" class="text-center text-muted py-4">Aucune donnée disponible</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-bold">Alertes stock critique</h5>
          <small class="text-muted">Produits nécessitant un réapprovisionnement</small>
        </div>
        <div class="card-body p-0">
          {% if stocksBas is empty %}
            <div class="alert alert-success mb-0 border-0 rounded-0">
              <i class="bi bi-check-circle-fill"></i> Aucun produit en stock critique
            </div>
          {% else %}
            <div class="table-responsive">
              <table class="table table-hover table-produits mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Produit</th>
                    <th>Catégorie</th>
                    <th class="text-center">Stock</th>
                    <th class="text-center">Statut</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in stocksBas %}
                    {% set stockClass2 = (s.quantite_produit >= 11) ? 'stock-ok' : (s.quantite_produit >= 5 ? 'stock-mid' : 'stock-low') %}
                    {% set st = (s.status_produit|lower) %}
                    {% set statusClass =
                      (st == 'rupture') ? 'status-rupture' :
                      (st == 'disponible') ? 'status-dispo' : 'status-autre'
                    %}
                    <tr>
                      <td class="fw-semibold">{{ s.nom_produit }}</td>
                      <td><span class="chip-cat">{{ s.categorie_produit }}</span></td>
                      <td class="text-center">
                        <span class="stock-pill {{ stockClass2 }}">{{ s.quantite_produit }}</span>
                      </td>
                      <td class="text-center">
                        <span class="status-pill {{ statusClass }}">{{ s.status_produit }}</span>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {# Conseils (inchangé) #}
  <div class="row g-3">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-bold">Recommandations stratégiques</h5>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            {% for t in tips %}
              <li class="mb-2">{{ t }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Données
const ventesJour = {{ charts.ventesJour|json_encode|raw }};
const categories = {{ charts.categories|json_encode|raw }};
const statuts = {{ charts.statuts|json_encode|raw }};

// Configuration couleurs (inchangée)
const colors = {
  primary: 'rgb(13, 110, 253)',
  success: 'rgb(25, 135, 84)',
  danger: 'rgb(220, 53, 69)',
  warning: 'rgb(255, 193, 7)',
  info: 'rgb(13, 202, 240)',
  purple: 'rgb(111, 66, 193)',
  orange: 'rgb(253, 126, 20)'
};

// Graphique principal : Ventes par jour (CA + Quantité)
new Chart(document.getElementById('chartVentesJour'), {
  data: {
    labels: ventesJour.map(r => r.jour),
    datasets: [
      {
        type: 'line',
        label: 'CA (DT)',
        data: ventesJour.map(r => r.ca),
        borderColor: colors.primary,
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        yAxisID: 'y1'
      },
      {
        type: 'bar',
        label: 'Quantité vendue',
        data: ventesJour.map(r => r.quantite),
        backgroundColor: 'rgba(25, 135, 84, 0.6)',
        borderColor: colors.success,
        borderWidth: 1,
        yAxisID: 'y'
      }
    ]
  },
  options: {
    responsive: true,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { position: 'top', labels: { font: { size: 13, weight: '600' } } },
      tooltip: {
        backgroundColor: 'rgba(0,0,0,0.8)',
        titleFont: { size: 13, weight: 'bold' },
        bodyFont: { size: 12 }
      }
    },
    scales: {
      y: {
        type: 'linear',
        display: true,
        position: 'left',
        title: { display: true, text: 'Quantité', font: { weight: 'bold' } },
        grid: { color: 'rgba(0,0,0,0.05)' }
      },
      y1: {
        type: 'linear',
        display: true,
        position: 'right',
        title: { display: true, text: 'CA (DT)', font: { weight: 'bold' } },
        grid: { drawOnChartArea: false }
      },
      x: { grid: { display: false } }
    }
  }
});

// Performance catégories
new Chart(document.getElementById('chartCategories'), {
  type: 'bar',
  data: {
    labels: categories.map(c => c.categorie),
    datasets: [
      {
        label: 'Quantité',
        data: categories.map(c => c.quantite),
        backgroundColor: 'rgba(111, 66, 193, 0.7)',
        borderColor: colors.purple,
        borderWidth: 1
      },
      {
        label: 'CA (DT)',
        data: categories.map(c => c.ca),
        backgroundColor: 'rgba(253, 126, 20, 0.7)',
        borderColor: colors.orange,
        borderWidth: 1
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'top', labels: { font: { size: 13, weight: '600' } } }
    },
    scales: {
      y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
      x: { grid: { display: false } }
    }
  }
});

// Statuts
new Chart(document.getElementById('chartStatuts'), {
  type: 'doughnut',
  data: {
    labels: statuts.map(s => s.label),
    datasets: [{
      data: statuts.map(s => s.value),
      backgroundColor: [
        'rgba(13, 110, 253, 0.8)',
        'rgba(25, 135, 84, 0.8)',
        'rgba(255, 193, 7, 0.8)',
        'rgba(220, 53, 69, 0.8)',
        'rgba(13, 202, 240, 0.8)'
      ],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'bottom', labels: { font: { size: 12 }, padding: 15 } }
    }
  }
});
</script>
{% endblock %}
