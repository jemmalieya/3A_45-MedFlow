{% extends 'base_dashboard.html.twig' %}

{% block title %}Ajouter un produit{% endblock %}

{% block body %}

{# =========================
   Helpers (Twig)
   - addClass(field, base) : ajoute is-valid / is-invalid
   - okText(field) : affiche "✅ C’est bon" si champ valide après submit
   ========================= #}
{% macro addClass(field, base) %}
  {% set cls = base %}
  {% if field.vars.submitted %}
    {% if field.vars.valid %}
      {% set cls = cls ~ ' is-valid' %}
    {% else %}
      {% set cls = cls ~ ' is-invalid' %}
    {% endif %}
  {% endif %}
  {{ cls }}
{% endmacro %}

{% macro okText(field) %}
  {% if field.vars.submitted and field.vars.valid %}
    <div class="valid-feedback d-block">✅ C’est bon</div>
  {% endif %}
{% endmacro %}

{% import _self as ui %}

<div class="container-fluid py-4 add-produit-page">
  <div class="row justify-content-center">
    <div class="col-xl-10">

      {# ====== HEADER ====== #}
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
          <h2 class="mb-1 fw-bold text-dark">
            <i class="bi bi-plus-circle text-primary me-2"></i>Ajouter un produit
          </h2>
          <p class="mb-0 text-dark-50">Remplissez les informations du nouveau produit</p>
        </div>

        <a href="{{ path('admin_produits_index') }}" class="btn btn-outline-secondary btn-lg">
          <i class="bi bi-arrow-left me-2"></i>Retour
        </a>
      </div>

      {# ====== FLASH (on garde pour compat, mais on affiche aussi en Swal) ====== #}
      <div id="flash-messages-container" class="d-none">
        {% for message in app.flashes('success') %}
          <div class="flash-success" data-message="{{ message|e('html_attr') }}"></div>
        {% endfor %}
        {% for message in app.flashes('error') %}
          <div class="flash-error" data-message="{{ message|e('html_attr') }}"></div>
        {% endfor %}
      </div>

      {# ====== FORM ====== #}
      {{ form_start(form, {'attr': {'novalidate': 'novalidate', 'id': 'addProduitForm'}}) }}

      <div class="row g-4">

        {# ====== LEFT ====== #}
        <div class="col-lg-8">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient-primary text-white py-3">
              <h5 class="mb-0 fw-bold">
                <i class="bi bi-info-circle me-2"></i>Informations principales
              </h5>
            </div>

            <div class="card-body p-4">

              {# NOM #}
              <div class="mb-4">
                <label class="form-label fw-bold text-dark">
                  <i class="bi bi-tag me-2"></i>Nom du produit <span class="text-danger">*</span>
                </label>
                {{ form_widget(form.nom_produit, {'attr': {'class': ui.addClass(form.nom_produit, 'form-control form-control-lg')}}) }}

                {% if form.nom_produit.vars.submitted and not form.nom_produit.vars.valid %}
                  <div class="invalid-feedback d-block">{{ form_errors(form.nom_produit) }}</div>
                {% endif %}
                {{ ui.okText(form.nom_produit) }}
              </div>

              {# DESCRIPTION #}
              <div class="mb-4">
                <label class="form-label fw-bold text-dark">
                  <i class="bi bi-card-text me-2"></i>Description <span class="text-danger">*</span>
                </label>
                {{ form_widget(form.description_produit, {'attr': {'class': ui.addClass(form.description_produit, 'form-control'), 'rows': 5}}) }}

                {% if form.description_produit.vars.submitted and not form.description_produit.vars.valid %}
                  <div class="invalid-feedback d-block">{{ form_errors(form.description_produit) }}</div>
                {% endif %}
                {{ ui.okText(form.description_produit) }}
              </div>

              <div class="row">
                {# PRIX #}
                <div class="col-md-6 mb-4">
                  <label class="form-label fw-bold text-dark">
                    <i class="bi bi-currency-dollar me-2"></i>Prix (DT) <span class="text-danger">*</span>
                  </label>

                  <div class="input-group input-group-lg">
                    {{ form_widget(form.prix_produit, {'attr': {'class': ui.addClass(form.prix_produit, 'form-control')}}) }}
                    <span class="input-group-text bg-primary-soft text-primary">
                      <i class="bi bi-cash-coin me-1"></i>DT
                    </span>
                  </div>

                  {% if form.prix_produit.vars.submitted and not form.prix_produit.vars.valid %}
                    <div class="invalid-feedback d-block">{{ form_errors(form.prix_produit) }}</div>
                  {% endif %}
                  {{ ui.okText(form.prix_produit) }}
                </div>

                {# QUANTITE #}
                <div class="col-md-6 mb-4">
                  <label class="form-label fw-bold text-dark">
                    <i class="bi bi-box-seam me-2"></i>Quantité <span class="text-danger">*</span>
                  </label>

                  {{ form_widget(form.quantite_produit, {'attr': {'class': ui.addClass(form.quantite_produit, 'form-control form-control-lg')}}) }}

                  {% if form.quantite_produit.vars.submitted and not form.quantite_produit.vars.valid %}
                    <div class="invalid-feedback d-block">{{ form_errors(form.quantite_produit) }}</div>
                  {% endif %}
                  {{ ui.okText(form.quantite_produit) }}
                </div>
              </div>

              {# CATEGORIE #}
              <div class="mb-4">
                <label class="form-label fw-bold text-dark">
                  <i class="bi bi-grid me-2"></i>Catégorie <span class="text-danger">*</span>
                </label>

                {{ form_widget(form.categorie_produit, {'attr': {'class': ui.addClass(form.categorie_produit, 'form-select form-select-lg')}}) }}

                {% if form.categorie_produit.vars.submitted and not form.categorie_produit.vars.valid %}
                  <div class="invalid-feedback d-block">{{ form_errors(form.categorie_produit) }}</div>
                {% endif %}
                {{ ui.okText(form.categorie_produit) }}
              </div>

              {# IMAGE #}
              <div class="mb-0">
                <label class="form-label fw-bold text-dark">
                  <i class="bi bi-image me-2"></i>URL de l'image <span class="text-danger">*</span>
                </label>

                <div class="input-group input-group-lg">
                  <span class="input-group-text bg-light">
                    <i class="bi bi-link-45deg"></i>
                  </span>
                  {{ form_widget(form.image_produit, {'attr': {'class': ui.addClass(form.image_produit, 'form-control')}}) }}
                </div>

                {% if form.image_produit.vars.submitted and not form.image_produit.vars.valid %}
                  <div class="invalid-feedback d-block">{{ form_errors(form.image_produit) }}</div>
                {% endif %}
                {{ ui.okText(form.image_produit) }}
              </div>

            </div>
          </div>
        </div>

        {# ====== RIGHT (status radios) ====== #}
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-0 py-3">
              <h6 class="mb-0 fw-bold text-dark">
                <i class="bi bi-toggle-on me-2"></i>Statut du produit
              </h6>
            </div>

            <div class="card-body p-4">
              <div class="status-radio-group">
                {{ form_widget(form.status_produit) }}
              </div>

              {% if form.status_produit.vars.submitted and not form.status_produit.vars.valid %}
                <div class="invalid-feedback d-block">{{ form_errors(form.status_produit) }}</div>
              {% endif %}
              {{ ui.okText(form.status_produit) }}

              <div class="mt-3 small text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Le statut contrôle l’affichage côté front.
              </div>
            </div>
          </div>
        </div>

      </div>

      {# ====== ACTIONS ====== #}
      <div class="card border-0 shadow-sm mt-4">
        <div class="card-body p-4">
          <div class="d-flex gap-3 justify-content-between align-items-center flex-wrap">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Les champs marqués d'un <span class="text-danger">*</span> sont obligatoires
            </small>

            <div class="d-flex gap-3">
              <a href="{{ path('admin_produits_index') }}" class="btn btn-outline-secondary btn-lg px-5">
                <i class="bi bi-x-circle me-2"></i>Annuler
              </a>

              <button type="submit" class="btn btn-primary btn-lg px-5" id="btnSubmitAddProduit">
                <i class="bi bi-check-circle me-2"></i>Ajouter le produit
              </button>
            </div>
          </div>
        </div>
      </div>

      {{ form_end(form) }}

    </div>
  </div>
</div>

{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    /* ================================
       ✅ SAME BLUE THEME AS LIST PAGE
       ================================ */
    :root{
      --blue-50:#eff6ff;
      --blue-100:#dbeafe;
      --blue-200:#bfdbfe;
      --blue-300:#93c5fd;
      --blue-400:#60a5fa;
      --blue-500:#3b82f6;
      --blue-600:#2563eb;
      --blue-700:#1d4ed8;
      --blue-800:#1e40af;
      --blue-900:#1e3a8a;
    }

    .add-produit-page{
      min-height: 100vh;
      background: linear-gradient(135deg, #f9fafb 0%, var(--blue-50) 100%);
    }
    .text-dark-50{ color:#6b7280 !important; }

    /* Header gradient like list */
    .bg-gradient-primary{
      background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-800) 100%) !important;
    }

    /* Cards */
    .card{
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(59,130,246,0.10);
    }
    .card-header{
      border-bottom: 2px solid var(--blue-200);
    }

    /* Inputs focus */
    .form-control:focus, .form-select:focus{
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.12);
    }

    /* Replace any "green" UI -> blue */
    .bg-primary-soft{
      background: linear-gradient(135deg, var(--blue-50) 0%, var(--blue-100) 100%) !important;
      border: 2px solid var(--blue-200) !important;
    }
    .text-primary{
      color: var(--blue-700) !important;
    }

    /* Feedback */
    .invalid-feedback{ font-weight:600; }
    .valid-feedback{ font-weight:600; }

    /* Status radios (blue selection) */
    .status-radio-group input[type="radio"]{ display:none; }

    .status-radio-group label{
      border: 1px solid #e5e7eb;
      padding: 14px;
      border-radius: 14px;
      display:block;
      margin-bottom: 12px;
      cursor:pointer;
      background:#fff;
      transition: .2s ease;
      font-weight:700;
      color:#111827 !important;
    }

    .status-radio-group label:hover{
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(59,130,246,.12);
      border-color: var(--blue-300);
    }

    .status-radio-group input[type="radio"]:checked + label{
      border-color: var(--blue-500);
      box-shadow: 0 0 0 4px rgba(59,130,246,.16);
      background: linear-gradient(135deg, #ffffff 0%, var(--blue-50) 100%);
    }

    .status-radio-group label::after{
      content:"";
      float:right;
      width:10px;height:10px;
      border-radius:50%;
      background:#d1d5db;
      margin-top:6px;
    }
    .status-radio-group input[type="radio"]:checked + label::after{
      background: var(--blue-600);
    }
  </style>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {

      // ===========
      // ✅ Toast (3s) après ajout/erreur via flash
      // ===========
      const successNodes = document.querySelectorAll('#flash-messages-container .flash-success');
      const errorNodes   = document.querySelectorAll('#flash-messages-container .flash-error');

      // Util petit helper
      function toast(icon, title) {
        if (typeof Swal === 'undefined') return;
        Swal.fire({
          position: "top-end",
          icon: icon,
          title: title,
          showConfirmButton: false,
          timer: 3000,
          timerProgressBar: true
        });
      }

      successNodes.forEach(n => toast('success', n.dataset.message || 'Ajouté avec succès ✅'));
      errorNodes.forEach(n => toast('error', n.dataset.message || 'Une erreur est survenue'));

      // ===========
      // ✅ Confirmation avant submit (SweetAlert2)
      // ===========
      const form = document.getElementById('addProduitForm');
      if (!form) return;

      form.addEventListener('submit', function(e) {
        // si Swal pas chargé => submit normal
        if (typeof Swal === 'undefined') return;

        e.preventDefault();

        const swalWithBootstrapButtons = Swal.mixin({
          customClass: {
            confirmButton: "btn btn-primary px-4",
            cancelButton: "btn btn-outline-secondary px-4"
          },
          buttonsStyling: false
        });

        swalWithBootstrapButtons.fire({
          title: "Confirmer l'ajout ?",
          text: "Le produit sera ajouté à votre inventaire.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Oui, ajouter",
          cancelButtonText: "Non, annuler",
          reverseButtons: true
        }).then((result) => {
          if (result.isConfirmed) {
            // Optionnel: mini toast immédiat avant submit
            toast('info', 'Ajout en cours...');
            form.submit();
          } else if (result.dismiss === Swal.DismissReason.cancel) {
            toast('error', 'Ajout annulé');
          }
        });
      });

    });
  </script>
{% endblock %}
