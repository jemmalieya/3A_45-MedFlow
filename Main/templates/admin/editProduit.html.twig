{% extends 'base_dashboard.html.twig' %}

{% block title %}Modifier Produit{% endblock %}

{% block body %}
<div class="container-fluid py-4 edit-produit-page">
  <div class="row justify-content-center">
    <div class="col-xl-10">

      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
          <h2 class="mb-1 fw-bold text-dark">
            <i class="bi bi-pencil-square text-warning me-2"></i>Modifier le produit
          </h2>
          <p class="mb-0 text-dark-50">Produit #{{ produit.id_produit }}</p>
        </div>

        <a href="{{ path('admin_produits_index') }}" class="btn btn-outline-secondary btn-lg">
          <i class="bi bi-arrow-left me-2"></i>Retour
        </a>
      </div>

      {# ===== FLASH ===== #}
      <div id="flash-messages-container">
        {% for message in app.flashes('success') %}
          <div class="alert alert-success alert-dismissible fade show flash-message shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>{{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
        {% for message in app.flashes('error') %}
          <div class="alert alert-danger alert-dismissible fade show flash-message shadow-sm" role="alert">
            <i class="bi bi-x-circle-fill me-2"></i>{{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      </div>

      {# =========================
         FORM START
         ========================= #}
      {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}

      {% set submitted = form.vars.submitted %}

      <div class="row g-4">

        {# ===== LEFT ===== #}
        <div class="col-lg-8">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient-primary text-white py-3">
              <h5 class="mb-0 fw-bold">
                <i class="bi bi-info-circle me-2"></i>Informations principales
              </h5>
            </div>

            <div class="card-body p-4">

              {# ---------- NOM ---------- #}
              {% set f = form.nom_produit %}
              <div class="mb-4">
                <label class="form-label fw-bold text-dark">
                  <i class="bi bi-tag me-2"></i>Nom du produit <span class="text-danger">*</span>
                </label>
                {{ form_widget(f, {'attr': {'class': 'form-control form-control-lg ' ~ (submitted ? (f.vars.valid ? 'is-valid' : 'is-invalid') : '')}}) }}
                <div class="invalid-feedback d-block">{{ form_errors(f) }}</div>
                {% if submitted and f.vars.valid %}
                  <div class="valid-feedback d-block">✅ OK</div>
                {% endif %}
              </div>

              {# ---------- DESCRIPTION ---------- #}
              {% set f = form.description_produit %}
              <div class="mb-4">
                <label class="form-label fw-bold text-dark">
                  <i class="bi bi-card-text me-2"></i>Description <span class="text-danger">*</span>
                </label>
                {{ form_widget(f, {'attr': {'class': 'form-control ' ~ (submitted ? (f.vars.valid ? 'is-valid' : 'is-invalid') : ''), 'rows': 5}}) }}
                <div class="invalid-feedback d-block">{{ form_errors(f) }}</div>
                {% if submitted and f.vars.valid %}
                  <div class="valid-feedback d-block">✅ OK</div>
                {% endif %}
              </div>

              <div class="row">
                {# ---------- PRIX ---------- #}
                {% set f = form.prix_produit %}
                <div class="col-md-6 mb-4">
                  <label class="form-label fw-bold text-dark">
                    <i class="bi bi-currency-dollar me-2"></i>Prix (DT) <span class="text-danger">*</span>
                  </label>
                  <div class="input-group input-group-lg">
                    {{ form_widget(f, {'attr': {'class': 'form-control ' ~ (submitted ? (f.vars.valid ? 'is-valid' : 'is-invalid') : '')}}) }}
                    <span class="input-group-text bg-primary-soft text-primary fw-bold">
                      <i class="bi bi-cash-coin me-1"></i>DT
                    </span>
                  </div>
                  <div class="invalid-feedback d-block">{{ form_errors(f) }}</div>
                  {% if submitted and f.vars.valid %}
                    <div class="valid-feedback d-block">✅ OK</div>
                  {% endif %}
                </div>

                {# ---------- QUANTITE ---------- #}
                {% set f = form.quantite_produit %}
                <div class="col-md-6 mb-4">
                  <label class="form-label fw-bold text-dark">
                    <i class="bi bi-box-seam me-2"></i>Quantité <span class="text-danger">*</span>
                  </label>
                  {{ form_widget(f, {'attr': {'class': 'form-control form-control-lg ' ~ (submitted ? (f.vars.valid ? 'is-valid' : 'is-invalid') : '')}}) }}
                  <div class="invalid-feedback d-block">{{ form_errors(f) }}</div>
                  {% if submitted and f.vars.valid %}
                    <div class="valid-feedback d-block">✅ OK</div>
                  {% endif %}
                </div>
              </div>

              {# ---------- CATEGORIE ---------- #}
              {% set f = form.categorie_produit %}
              <div class="mb-4">
                <label class="form-label fw-bold text-dark">
                  <i class="bi bi-grid me-2"></i>Catégorie <span class="text-danger">*</span>
                </label>
                {{ form_widget(f, {'attr': {'class': 'form-select form-select-lg ' ~ (submitted ? (f.vars.valid ? 'is-valid' : 'is-invalid') : '')}}) }}
                <div class="invalid-feedback d-block">{{ form_errors(f) }}</div>
                {% if submitted and f.vars.valid %}
                  <div class="valid-feedback d-block">✅ OK</div>
                {% endif %}
              </div>

              {# ---------- IMAGE ---------- #}
              {% set f = form.image_produit %}
              <div class="mb-0">
                <label class="form-label fw-bold text-dark">
                  <i class="bi bi-image me-2"></i>URL de l'image <span class="text-danger">*</span>
                </label>
                <div class="input-group input-group-lg">
                  <span class="input-group-text bg-light">
                    <i class="bi bi-link-45deg"></i>
                  </span>
                  {{ form_widget(f, {'attr': {'class': 'form-control ' ~ (submitted ? (f.vars.valid ? 'is-valid' : 'is-invalid') : '')}}) }}
                </div>
                <div class="invalid-feedback d-block">{{ form_errors(f) }}</div>
                {% if submitted and f.vars.valid %}
                  <div class="valid-feedback d-block">✅ OK</div>
                {% endif %}
              </div>

            </div>
          </div>
        </div>

        {# ===== RIGHT ===== #}
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-0 py-3">
              <h6 class="mb-0 fw-bold text-dark">
                <i class="bi bi-toggle-on me-2"></i>Statut du produit
              </h6>
            </div>

            <div class="card-body p-4">
              {% set f = form.status_produit %}

              <div class="status-radio-group {{ submitted ? (f.vars.valid ? 'block-valid' : 'block-invalid') : '' }}">
                {{ form_widget(f) }}
              </div>

              <div class="invalid-feedback d-block mt-2">{{ form_errors(f) }}</div>
              {% if submitted and f.vars.valid %}
                <div class="valid-feedback d-block mt-2">✅ OK</div>
              {% endif %}

              <div class="mt-3 small text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Le statut contrôle l’affichage côté front.
              </div>
            </div>
          </div>
        </div>

      </div>

      {# ===== ACTIONS ===== #}
      <div class="card border-0 shadow-sm mt-4">
        <div class="card-body p-4">
          <div class="d-flex gap-3 justify-content-between align-items-center flex-wrap">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Les champs marqués d'un <span class="text-danger">*</span> sont obligatoires
            </small>

            <div class="d-flex gap-3">
              <a href="{{ path('admin_produits_index') }}" class="btn btn-outline-secondary btn-lg px-5">
                <i class="bi bi-x-circle me-2"></i>Annuler
              </a>

              <button type="submit" class="btn btn-warning btn-lg px-5">
                <i class="bi bi-save2 me-2"></i>Mettre à jour
              </button>
            </div>
          </div>
        </div>
      </div>

      {{ form_end(form) }}
    </div>
  </div>
</div>
{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="{{ asset('assets_dash/css/produits.css') }}">
  <style>
    /* ================================
       ✅ SAME BLUE THEME AS LIST PAGE
       ================================ */
    :root{
      --blue-50:#eff6ff;
      --blue-100:#dbeafe;
      --blue-200:#bfdbfe;
      --blue-300:#93c5fd;
      --blue-400:#60a5fa;
      --blue-500:#3b82f6;
      --blue-600:#2563eb;
      --blue-700:#1d4ed8;
      --blue-800:#1e40af;
      --blue-900:#1e3a8a;
    }

    .edit-produit-page{
      min-height: 100vh;
      background: linear-gradient(135deg, #f9fafb 0%, var(--blue-50) 100%);
    }
    .edit-produit-page, .edit-produit-page * { color:#111827; }
    .text-dark-50{ color:#6b7280 !important; }

    .bg-gradient-primary{
      background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-800) 100%) !important;
      border-bottom: 2px solid var(--blue-200);
    }

    /* ✅ Validation Bootstrap style (force display) */
    .invalid-feedback, .valid-feedback{ font-size:.85rem; font-weight:600; }

    /* ✅ Radio block : BLUE (no green) */
    .block-valid{
      border: 1px solid var(--blue-500);
      border-radius: 14px;
      padding: 12px;
      background: rgba(59,130,246,.06);
    }
    .block-invalid{
      border: 1px solid #dc3545;
      border-radius: 14px;
      padding: 12px;
      background: rgba(220,53,69,.04);
    }

    /* Input focus */
    .form-control:focus, .form-select:focus{
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.12);
    }

    /* DT badge (no green) */
    .bg-primary-soft{
      background: linear-gradient(135deg, var(--blue-50) 0%, var(--blue-100) 100%) !important;
      border: 2px solid var(--blue-200) !important;
    }
    .text-primary{ color: var(--blue-700) !important; }

    /* Status radios => cards */
    .status-radio-group input[type="radio"]{ display:none; }

    .status-radio-group label{
      border:1px solid #e5e7eb;
      padding:14px 14px;
      border-radius:14px;
      display:block;
      margin-bottom:12px;
      cursor:pointer;
      background:#fff;
      transition: .2s ease;
      font-weight:700;
      color:#111827 !important;
    }
    .status-radio-group label:hover{
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(59,130,246,.12);
      border-color: var(--blue-300);
    }
    .status-radio-group input[type="radio"]:checked + label{
      border-color: var(--blue-500);
      box-shadow: 0 0 0 4px rgba(59,130,246,.16);
      background: linear-gradient(135deg, #ffffff 0%, var(--blue-50) 100%);
    }
    .status-radio-group label::after{
      content:"";
      float:right;
      width:10px;height:10px;
      border-radius:50%;
      background:#d1d5db;
      margin-top:6px;
    }
    .status-radio-group input[type="radio"]:checked + label::after{
      background: var(--blue-600);
    }

    /* Flash animation */
    .flash-message{ border-left: 4px solid; animation: slideInDown .35s ease; }
    .flash-message.slide-out{ animation: slideOutUp .35s ease forwards; }
    @keyframes slideInDown{ from{opacity:0;transform:translateY(-25px);} to{opacity:1;transform:translateY(0);} }
    @keyframes slideOutUp{ from{opacity:1;transform:translateY(0);} to{opacity:0;transform:translateY(-25px);} }
  </style>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="{{ asset('assets_dash/js/produits.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.flash-message').forEach(msg => {
        setTimeout(() => {
          msg.classList.add('slide-out');
          setTimeout(() => msg.remove(), 350);
        }, 3000);
      });
    });
  </script>
{% endblock %}
