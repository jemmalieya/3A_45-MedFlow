{% extends 'base.html.twig' %}
{% block title %}Agenda Admin Événements - MedFlow{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <style>
    .cal-wrap{background:#fff;border:1px solid rgba(16,24,40,.08);border-radius:18px;box-shadow:0 14px 40px rgba(16,24,40,.08);overflow:hidden}
    .cal-head{padding:16px 18px;background:linear-gradient(135deg,#0097B2,#00BFA6);color:#fff;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
    .cal-filters{padding:14px 18px;border-bottom:1px solid rgba(16,24,40,.08);background:#f4fcfb}
    #calendar{padding:14px 18px}
    .fc .fc-button-primary{background:#0097B2!important;border-color:#0097B2!important}
  </style>
{% endblock %}

{% block body %}
<main class="main">
  <section class="section" style="padding-top:120px;">
    <div class="container">
      <div class="cal-wrap">
        <div class="cal-head">
          <div>
            <h3 class="mb-0 fw-bold"><i class="bi bi-calendar2-week me-2"></i> Agenda Admin</h3>
            <div class="small opacity-75">Drag & Drop (déplacer dates) + modal + filtres</div>
          </div>
          <a href="{{ path('admin_evenement_index') }}" class="btn btn-light btn-sm fw-bold">
            <i class="bi bi-arrow-left me-1"></i> Retour back-office
          </a>
        </div>

        <div class="cal-filters">
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label mb-1 fw-semibold">Ville</label>
              <select id="filterVille" class="form-select">
                <option value="">Toutes</option>
                {% for v in villes %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label mb-1 fw-semibold">Type</label>
              <select id="filterType" class="form-select">
                <option value="">Tous</option>
                {% for t in types %}<option value="{{ t }}">{{ t }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label mb-1 fw-semibold">Statut</label>
              <select id="filterStatut" class="form-select">
                <option value="">Tous</option>
                {% for s in statuts %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label mb-1 fw-semibold">Recherche</label>
              <input id="filterQ" class="form-control" placeholder="Titre, ville, type, lieu...">
            </div>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button id="btnReset" class="btn btn-outline-secondary">Réinitialiser</button>
            <span class="ms-auto small text-muted">
              <i class="bi bi-info-circle me-1"></i> Glisser un événement pour changer ses dates.
            </span>
          </div>
        </div>

        <div id="calendar"></div>
      </div>
    </div>
  </section>
</main>

{# MODAL (même que front) #}
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="border-radius:18px; overflow:hidden;">
      <div class="modal-header" style="background:linear-gradient(135deg,#0097B2,#00BFA6); color:#fff;">
        <h5 class="modal-title fw-bold" id="mTitle">Détails</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex flex-wrap gap-2 mb-3">
          <span class="badge rounded-pill" id="mStatut" style="background:#0097B2;"></span>
          <span class="badge rounded-pill bg-light text-dark border" id="mType"></span>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="fw-semibold mb-1"><i class="bi bi-geo-alt me-1"></i> Lieu</div>
            <div class="text-muted" id="mLieu"></div>
            <div class="text-muted small" id="mAdresse"></div>
          </div>
          <div class="col-md-6">
            <div class="fw-semibold mb-1"><i class="bi bi-calendar-event me-1"></i> Dates</div>
            <div class="text-muted" id="mDates"></div>
            <div class="text-muted small"><i class="bi bi-pin-map me-1"></i><span id="mVille"></span></div>
          </div>
        </div>

        <hr>
        <a id="mGo" class="btn btn-primary w-100" href="#">
          <i class="bi bi-eye me-1"></i> Ouvrir la page front (détail)
        </a>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const villeEl  = document.getElementById('filterVille');
      const typeEl   = document.getElementById('filterType');
      const statutEl = document.getElementById('filterStatut');
      const qEl      = document.getElementById('filterQ');

      const csrfMove = {{ csrfMove|json_encode|raw }};

      const modal = new bootstrap.Modal(document.getElementById('eventModal'));

      const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        height: 'auto',
        locale: 'fr',
        editable: true,            // ✅ drag & drop
        eventDurationEditable: true,
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },

        eventClick: (info) => {
          info.jsEvent.preventDefault();

          const p = info.event.extendedProps || {};
          document.getElementById('mTitle').textContent = info.event.title || 'Événement';
          document.getElementById('mStatut').textContent = p.statut || 'N/A';
          document.getElementById('mType').textContent = p.type || 'N/A';
          document.getElementById('mLieu').textContent = p.lieu || '-';
          document.getElementById('mAdresse').textContent = p.adresse || '';
          document.getElementById('mDates').textContent = (p.debut || '') + ' → ' + (p.fin || '');
          document.getElementById('mVille').textContent = p.ville || '-';
          document.getElementById('mGo').href = p.url || '#';

          document.getElementById('mStatut').style.background = info.event.backgroundColor || '#0097B2';
          modal.show();
        },

        eventDrop: (info) => {
          // ✅ Save DB
          fetch('{{ path("admin_evenements_calendar_move") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              _token: csrfMove,
              id: info.event.id,
              start: info.event.startStr,
              end: info.event.endStr
            })
          })
          .then(r => r.json())
          .then(res => {
            if (!res.ok) {
              info.revert();
              alert(res.message || 'Erreur update');
            }
          })
          .catch(() => {
            info.revert();
            alert('Erreur réseau');
          });
        },

        events: (fetchInfo, success, failure) => {
          const params = new URLSearchParams();
          params.set('start', fetchInfo.startStr);
          params.set('end', fetchInfo.endStr);
          if (villeEl.value)  params.set('ville', villeEl.value);
          if (typeEl.value)   params.set('type', typeEl.value);
          if (statutEl.value) params.set('statut', statutEl.value);
          if (qEl.value.trim()) params.set('q', qEl.value.trim());

          fetch('{{ path("admin_evenements_calendar_data") }}?' + params.toString())
            .then(r => r.json())
            .then(success)
            .catch(failure);
        }
      });

      calendar.render();

      // live refresh (debounce)
      let t = null;
      function refetchSoon(){
        clearTimeout(t);
        t = setTimeout(() => calendar.refetchEvents(), 250);
      }
      [villeEl, typeEl, statutEl].forEach(el => el.addEventListener('change', refetchSoon));
      qEl.addEventListener('input', refetchSoon);

      document.getElementById('btnReset').addEventListener('click', () => {
        villeEl.value=''; typeEl.value=''; statutEl.value=''; qEl.value='';
        calendar.refetchEvents();
      });
    });
  </script>
{% endblock %}
