{% extends 'base.html.twig' %}
{% set patientId = app.session.get('patient_id') %}
{% block body %}
<style>
    .appointment-page { min-height: 100vh; background: #fff; padding: 2rem 0 4rem; }
    .appointment-hero {
      background: linear-gradient(135deg, #2563eb 0%, #38bdf8 50%, #1e40af 100%);
      color: #fff;
      padding: 3rem 2rem;
      border-radius: 24px;
      margin-bottom: 2.5rem;
      box-shadow: 0 20px 50px rgba(37, 99, 235, 0.25);
      text-align: center;
    }
    .appointment-hero h1 { font-size: 2.25rem; font-weight: 800; letter-spacing: -0.02em; margin: 0 0 0.5rem; }
    .appointment-hero p { font-size: 1.1rem; opacity: 0.95; margin: 0; font-weight: 500; }
    .appointment-card {
      background: #e0f2fe;
      border-radius: 20px;
      box-shadow: 0 4px 24px rgba(37,99,235,0.08), 0 1px 3px rgba(30,64,175,0.04);
      border: 1px solid #2563eb33;
      padding: 2rem 2.5rem;
      margin-bottom: 2rem;
    }
    .appointment-card .form-label { font-weight: 600; color: #2563eb; margin-bottom: 0.5rem; }
    .appointment-card .form-control, .appointment-card .form-select {
      border: 2px solid #2563eb;
      border-radius: 12px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .appointment-card .form-control:focus, .appointment-card .form-select:focus {
      border-color: #1e40af;
      box-shadow: 0 0 0 4px #2563eb33;
      outline: none;
    }
    .appointment-card .form-control[readonly], .appointment-card .form-control:disabled,
    .appointment-card .form-control.bg-muted { background: #dbeafe; color: #2563eb; }
    .btn-appointment {
      background: linear-gradient(135deg, #2563eb 0%, #38bdf8 100%);
      color: #fff !important;
      border: none;
      border-radius: 14px;
      padding: 1rem 2rem;
      font-weight: 700;
      font-size: 1.05rem;
      letter-spacing: 0.02em;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-appointment:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(37, 99, 235, 0.35); color: #fff !important; }
    .alert-appointment { border: none; border-radius: 14px; padding: 1rem 1.25rem; font-weight: 500; }
    .alert-appointment.alert-danger { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); color: #991b1b; }
    .alert-appointment.alert-success { background: linear-gradient(135deg, #dbeafe 0%, #bae6fd 100%); color: #2563eb; }
    #appointment-form { padding-top: 100px; }
    @media (max-width: 768px) { #appointment-form { padding-top: 80px; } .appointment-hero h1 { font-size: 1.75rem; } }
    .flatpickr-calendar { background: #fff !important; border: 2px solid #e2e8f0 !important; border-radius: 16px !important; box-shadow: 0 10px 40px rgba(0,0,0,0.08) !important; }
    .flatpickr-day.today { border-color: #0d9488; }
    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange { background: #0d9488 !important; color: #fff !important; }
    .flatpickr-weekday { color: #0f766e; }
    .flatpickr-input { width: 100% !important; padding: 0.75rem 1rem !important; border-radius: 12px !important; }
    #appointment-form .col-lg-8 .flatpickr-calendar.inline { max-width: 520px !important; margin: 0.5rem auto 0 !important; }
</style>

<main class="main appointment-page">
    <section id="appointment-form" class="section py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="appointment-hero">
                        <h1>ðŸ“… Prendre rendez-vous</h1>
                        <p>Choisissez la date, l'heure et le motif â€” nous nous occupons du reste.</p>
                    </div>

                    {% for label, messages in app.flashes %}
                      {% for message in messages %}
                        <div class="alert alert-appointment alert-{{ label == 'error' ? 'danger' : 'success' }}">{{ message }}</div>
                      {% endfor %}
                    {% endfor %}

                    <div class="appointment-card">
                        {% if form.vars.errors|length > 0 %}
                          <div style="color: #dc3545; font-size: 1em; font-weight: bold;">
                            Erreurs du formulaire :
                            <ul>
                              {% for error in form.vars.errors %}<li>{{ error.message }}</li>{% endfor %}
                            </ul>
                          </div>
                        {% endif %}
                        {{ form_start(form, {'attr': {'novalidate': 'novalidate', 'id': 'appointment-form-main'}}) }}
                        <div class="mb-4">
                          <div id="fullcalendar"></div>
                          <div id="selected-date-label" style="margin-top:1rem;font-weight:bold;color:#2563eb;"></div>
                          <input type="hidden" id="calendar-datetime" name="{{ form.datetime.vars.full_name }}" value="{{ form.datetime.vars.value|default('') }}">
                          {{ form_errors(form.datetime) }}
                          {% if form.datetime.vars.errors|length > 0 and form.datetime.vars.value is empty %}
                            <div style="color: #dc3545; font-size: 0.95em;">Ce champ est obligatoire. Veuillez choisir une date et une heure.</div>
                          {% endif %}
                        </div>
                        {{ form_row(form.mode) }}
                        {{ form_row(form.motif) }}
                        {{ form_row(form._token) }}
                        <div class="d-grid mt-4">
                          <button type="submit" class="btn btn-appointment">Envoyer la demande</button>
                        </div>
                        {{ form_end(form, {'render_rest': false}) }}
                            <style>
                              /* Hide any default datetime widget that may be rendered by Symfony */
                              input[type="datetime-local"], .js-datepicker, .flatpickr-input {
                                display: none !important;
                              }
                            </style>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">Patient</label>
                                    <div class="form-control bg-muted" style="pointer-events: none;">
                                      <strong>
                                        {% if form.vars.data.patient and form.vars.data.patient.id == patientId %}
                                          Moi ({{ form.vars.data.patient.nom ~ ' ' ~ form.vars.data.patient.prenom }})
                                        {% else %}
                                          {{ form.vars.data.patient ? form.vars.data.patient.nom ~ ' ' ~ form.vars.data.patient.prenom : 'Non dÃ©fini' }}
                                        {% endif %}
                                      </strong>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Personnel mÃ©dical</label>
                                    <div class="form-control bg-muted" style="pointer-events: none;">
                                      <strong>{{ form.vars.data.staff ? form.vars.data.staff.nom ~ ' ' ~ form.vars.data.staff.prenom : 'Non dÃ©fini' }}</strong>
                                    </div>
                                </div>
                            </div>
                            <!-- All form fields above -->
                           
                       
                        {{ form_end(form, {'render_rest': false}) }}
                    </div>

                </div>
            </div>
        </div>
    </section>
</main>
{% block javascripts %}
  {{ parent() }}
  <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/main.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.11/main.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.11/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.11/index.global.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // On form submit, set hidden input from label if label exists
    var form = document.getElementById('appointment-form-main');
    if (form) {
      form.addEventListener('submit', function(e) {
        var input = document.getElementById('calendar-datetime');
        var dateLabel = document.getElementById('selected-date-label');
        // If label is set, set input value in 'YYYY-MM-DDTHH:mm' format
        if (dateLabel && input && dateLabel.textContent.trim() !== '') {
          var labelVal = dateLabel.textContent.trim();
          // Convert 'YYYY-MM-DD HH:mm:00' to 'YYYY-MM-DDTHH:mm'
          var match = labelVal.match(/(\d{4}-\d{2}-\d{2}) (\d{2}):(\d{2}):\d{2}/);
          if (match) {
            input.value = match[1] + 'T' + match[2] + ':' + match[3];
          }
        }
        // DEBUG: Log to console
        console.log('Form submit: hidden input value =', input ? input.value : 'null');
      });
    }
    var calendarEl = document.getElementById('fullcalendar');
    var input = document.getElementById('calendar-datetime');
    var initialDate = input.value ? new Date(input.value) : new Date();

    var doctorId = {{ form.vars.data.staff ? form.vars.data.staff.id : 'null' }};
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      nowIndicator: true,
      selectable: true,
      allDaySlot: false,
      weekends: false,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      height: 500,
      slotMinTime: '08:00:00',
      slotMaxTime: '17:00:00',
      slotDuration: '01:00:00',
      snapDuration: '01:00:00',
      events: doctorId ? '/doctor/appointments/' + doctorId : [],
      eventColor: '#dc3545', // Red
      eventRender: function(info) {
        info.el.style.backgroundColor = '#dc3545';
        info.el.style.borderColor = '#dc3545';
        info.el.style.color = '#fff';
      },
      eventContent: function(arg) {
        return { html: '<div style="color:#fff;font-weight:bold">OccupÃ©(e)</div>' };
      },
      businessHours: {
        daysOfWeek: [1, 2, 3, 4, 5], // Monday to Friday
        startTime: '08:00',
        endTime: '17:00'
      },
      selectConstraint: 'businessHours',
      eventOverlap: false,
      selectAllow: function(selectInfo) {
        // Prevent booking in occupied hours
        var events = calendar.getEvents();
        for (var i = 0; i < events.length; i++) {
          if (
            selectInfo.start < events[i].end &&
            selectInfo.end > events[i].start
          ) {
            return false;
          }
        }
        // Only allow 1 hour slots
        var diff = (selectInfo.end - selectInfo.start) / (1000 * 60 * 60);
        return diff === 1;
      },
      select: function(info) {
        // Set the hidden input value to the selected datetime in 'YYYY-MM-DDTHH:mm' format for Symfony
        var input = document.getElementById('calendar-datetime');
        if (input) {
          var dt = new Date(info.startStr);
          var year = dt.getFullYear();
          var month = ('0' + (dt.getMonth() + 1)).slice(-2);
          var day = ('0' + dt.getDate()).slice(-2);
          var hour = ('0' + dt.getHours()).slice(-2);
          var minute = ('0' + dt.getMinutes()).slice(-2);
          input.value = year + '-' + month + '-' + day + 'T' + hour + ':' + minute;
        }
        // Show selected date/time below the calendar in 'YYYY-MM-DD HH:mm:00' format
        var dateLabel = document.getElementById('selected-date-label');
        if (dateLabel) {
          var dt = new Date(info.startStr);
          var year = dt.getFullYear();
          var month = ('0' + (dt.getMonth() + 1)).slice(-2);
          var day = ('0' + dt.getDate()).slice(-2);
          var hour = ('0' + dt.getHours()).slice(-2);
          var minute = ('0' + dt.getMinutes()).slice(-2);
          dateLabel.textContent = year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':00';
        }
        // Remove previous selection highlight
        var selectedEls = document.querySelectorAll('.fc-slot-selected');
        selectedEls.forEach(function(el) { el.classList.remove('fc-slot-selected'); });
        // Highlight the selected slot
        var slotSelector = '[data-time="' + info.startStr.substring(11,16) + '"]';
        var dayCol = document.querySelector('[data-date="' + info.startStr.substring(0,10) + '"]');
        if(dayCol) {
          var slot = dayCol.querySelector(slotSelector);
          if(slot) slot.classList.add('fc-slot-selected');
        }
      },
    });
    calendar.render();
  });
  </script>
{% endblock %}
{% endblock %}